<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sprint Tracker ‚Äì Aline & Caio - V3.1</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e8ecf1; --accent:#6ee7b7; --accent2:#60a5fa; --danger:#f87171; --warn:#fbbf24;
      --card:#1e2338; --border:#2b3151;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 600px at 20% -10%,#1c2040 0%,transparent 65%),radial-gradient(1000px 800px at 120% 10%,#112033 0%,transparent 60%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(15,18,32,.95),rgba(15,18,32,.75));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:20px;margin:0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);color:var(--text)}
    select,input,button,textarea{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:9px 10px;outline:none}
    select:focus,input:focus,textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(96,165,250,.25)}
    button{cursor:pointer}
    .btn{border:1px solid var(--border);background:var(--card)}
    .btn.primary{background:linear-gradient(180deg,#1f8b6a,#146a53);border-color:#2f9b7b}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.ghost{background:transparent}
    .btn.warn{background:#3a2c11;border-color:#6b4c12;color:#ffd88a}
    .btn.danger{background:#3a1717;border-color:#6b1f1f;color:#ffb3b3}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (min-width:900px){.grid{grid-template-columns:320px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .card h3{margin:0 0 8px;font-size:16px}
    .kanban{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media (min-width:900px){.kanban{grid-template-columns:repeat(4,1fr)}}
    .col{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:10px;min-height:240px}
    .col h4{margin:4px 6px 8px;font-size:14px;color:var(--muted)}
    .task{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;margin:8px;display:grid;gap:8px;box-shadow:0 2px 0 rgba(0,0,0,.2)}
    .task.dragging{opacity:.6;outline:2px dashed var(--accent2)}
    .col.dragover{outline:2px dashed var(--accent2)}
    .row-between{display:flex;justify-content:space-between;align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px;border:1px solid var(--border);background:#11162a; color:#c9d3e3}
    .points{background:#1b2b1e;color:#b7fdd4;border-color:#214e35}
    .assignee{background:#162338;color:#cfe3ff;border-color:#274168}
    .done .title{text-decoration:line-through;color:#a7b0c0}
    .muted{color:var(--muted)}
    .stats{display:grid;gap:16px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));}
    .stat{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    .stat .n{font-size:20px;font-weight:700}
    .progress{height:10px;border-radius:999px;background:#121527;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#60a5fa,#6ee7b7)}
    .epic{background:#30224a;border-color:#523d7e;color:#e6d8ff}
    .tag{background:#26343a;border-color:#35606b;color:#c7f2ff;font-size:11px;padding:3px 6px}
    .taglist{display:flex;flex-wrap:wrap;gap:6px}
    .epic-chip{display:inline-flex;align-items:center;gap:6px}
    .epic-chip button{all:unset;cursor:pointer;font-weight:700;line-height:1;padding:0 6px;border-radius:8px;color:#fbb6b6}
    .epic-chip button:hover{background:#44222a}
    dialog{border:none;border-radius:16px;background:var(--panel);color:var(--text);box-shadow:0 20px 60px rgba(0,0,0,.45);}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .pill-container { margin-top: 16px; gap: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:10px;align-items:center">
          <h1 id="sprintTitle">üèÅ Sprint Tracker ‚Äì V3.1</h1><button class="btn ghost" id="editSprintNameBtn" title="Editar nome da sprint" style="padding:6px 8px">‚úé</button>
          <span id="dateBadge" class="pill">Carregando‚Ä¶</span>
        </div>
        <div class="row">
          <select id="sprintSelect" title="Selecionar sprint"></select>
          <select id="epicFilter" title="Filtrar por √©pico"><option value="all">Todos os √©picos</option></select>
          <button class="btn" id="addSprintBtn">+ Nova Sprint</button>
          <button class="btn" id="exportBtn" title="Exportar JSON (Backup)">Backup</button>
          <button class="btn warn" id="resetBtn" title="Limpar dados do Firebase">Limpar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="display:grid;gap:14px">
    <section class="grid">
      <div class="card">
        <h3>Adicionar tarefa</h3>
        <form id="taskForm" class="row" style="gap:10px">
          <input required name="title" placeholder="T√≠tulo da tarefa" style="flex:1"/>
          <select name="epicId" id="epicSelect" required> <option value="">√âpico‚Ä¶</option> </select>
          <input name="tags" placeholder="tags (v√≠rgulas)" style="min-width:180px" />
          <select name="assignee" required> <option value="Aline">Aline</option> <option value="Caio">Caio</option> </select>
          <select name="points" required> <option value="0">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="5" selected>5</option> <option value="8">8</option> <option value="13">13</option> <option value="21">21</option> <option value="34">34</option> </select>
          <select name="status" required> <option value="todo">A fazer</option> <option value="doing">Em andamento</option> <option value="done">Conclu√≠da</option> <option value="notdone">N√£o conclu√≠da</option> </select>
          <button class="btn primary" type="submit">Adicionar</button>
        </form>
      </div>
      <div class="card">
        <h3>Resumo da sprint</h3>
        <div class="stats" id="stats"></div>
        <div style="margin-top:8px">
          <div class="row-between"><span class="muted">Progresso Aline</span><span id="progressAlinePct">0%</span></div>
          <div class="progress"><div id="progressAlineBar" class="bar" style="width:0%"></div></div>
          <div class="row-between" style="margin-top:6px"><span class="muted">Progresso Caio</span><span id="progressCaioPct">0%</span></div>
          <div class="progress"><div id="progressCaioBar" class="bar" style="width:0%"></div></div>
          <div class="row pill-container">
            <span class="pill" id="concluidoAline">Conclu√≠do Aline: 0 pts</span>
            <span class="pill" id="concluidoCaio">Conclu√≠do Caio: 0 pts</span>
          </div>
        </div>
      </div>
    </section>
    <section class="card">
      <h3>√âpicos</h3>
      <div id="epicList" class="taglist" style="margin-bottom:8px"></div>
      <div class="row" style="gap:8px">
        <input id="newEpicName" placeholder="Novo √©pico (ex.: Sa√∫de)"/>
        <button class="btn" id="addEpicBtn">Adicionar √©pico</button>
      </div>
    </section>
    <section class="kanban">
      <div class="col" data-col="todo"> <h4>üóÇÔ∏è A fazer (<span class="muted" id="todoCount">0</span>)</h4> <div class="dropzone" id="todo"></div> </div>
      <div class="col" data-col="doing"> <h4>üöß Em andamento (<span class="muted" id="doingCount">0</span>)</h4> <div class="dropzone" id="doing"></div> </div>
      <div class="col" data-col="done"> <h4>‚úÖ Conclu√≠da (<span class="muted" id="doneCount">0</span>)</h4> <div class="dropzone" id="done"></div> </div>
    
  <div class="col" data-col="notdone"> <h4>‚ùå N√£o conclu√≠da (<span class="muted" id="notDoneCount">0</span>)</h4> <div class="dropzone" id="notdone"></div> </div>
  </section>
</main>
  <dialog id="editModal">
    <form method="dialog" id="editForm" style="min-width:320px;max-width:520px;padding:12px">
      <h3>Editar tarefa</h3>
      <input name="title" placeholder="T√≠tulo" style="width:100%;margin:6px 0" />
      <div class="row" style="gap:8px;margin:6px 0">
        <select name="assignee"> <option value="Aline">Aline</option> <option value="Caio">Caio</option> </select>
        <select name="points"> <option>0</option><option>1</option><option>2</option><option>3</option><option>5</option><option>8</option><option>13</option><option>21</option><option>34</option> </select>
        <select name="status"> <option value="todo">A fazer</option> <option value="doing">Em andamento</option> <option value="done">Conclu√≠da</option> <option value="notdone">N√£o conclu√≠da</option> </select>
      </div>
      <div class="row" style="gap:8px;margin:6px 0">
        <select name="epicId"></select>
        <input name="tags" placeholder="tags (v√≠rgulas)" />
      </div>
      <textarea name="notes" rows="3" placeholder="Notas / crit√©rio de aceite (opcional)" style="width:100%;margin:6px 0"></textarea>
      <div style="margin: 12px 0;">
        <h4 id="checklistTitle" style="margin: 0 0 8px; font-size: 14px;">Checklist</h4>
        <div id="checklistContainer"></div>
        <div class="row" style="gap: 8px; margin-top: 8px;">
          <input id="newChecklistItem" placeholder="Novo item do checklist..." style="flex: 1;" />
          <button type="button" class="btn" id="addChecklistItemBtn">Adicionar item</button>
        </div>
      </div>
      <div class="modal-actions">
        <div class="modal-actions">
          <button type="button" class="btn danger" value="delete">Excluir</button>
          <button type="button" class="btn" value="cancel">Cancelar</button>
          <button type="submit" class="btn primary" value="save">Salvar</button>
        </div>
    </form>
  </dialog>
  <dialog id="sprintModal">
    <form method="dialog" id="sprintForm" style="min-width:320px;max-width:520px;padding:12px">
      <h3>Nova Sprint</h3>
      <label>Nome<input name="name" placeholder="Sprint X" style="width:100%;margin:6px 0" required></label>
      <div class="row" style="gap:8px;margin:6px 0">
        <label class="sr" for="startDate">In√≠cio</label> <input id="startDate" name="start" type="date" required>
        <label class="sr" for="endDate">Fim</label> <input id="endDate" name="end" type="date" required>
      </div>
      <div class="modal-actions">
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn primary" value="create">Criar</button>
      </div>
    </form>
  </dialog>

<script type="module">

// --- In√≠cio da Configura√ß√£o do Firebase ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyBjUoks9OQxUQ6_rdUSXE-ZLzjQrjLNVh8",
    authDomain: "sprint-tracker-aline-caio.firebaseapp.com",
    projectId: "sprint-tracker-aline-caio",
    storageBucket: "sprint-tracker-aline-caio.appspot.com",
    messagingSenderId: "1096785458487",
    appId: "1:1096785458487:web:c89269c1c00d2a9b9316b2"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
// --- Fim da Configura√ß√£o do Firebase ---

// --- Seletores e Estado Global ---
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
let state = { sprints: [], selected: 0 };
const sprintsCol = collection(db, 'sprints');

// --- Fun√ß√µes de Ajuda (Helpers) ---
const cryptoRandomId = () => crypto.randomUUID ? crypto.randomUUID() : `id-${Math.random().toString(36).slice(2)}`;
const escapeHtml = str => String(str || '').replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
const fmtDate = iso => new Date(`${iso}T00:00:00`).toLocaleDateString('pt-BR');
const addDays = (iso, n) => {
    const d = new Date(`${iso}T00:00:00`);
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0, 10);
};
const currentSprint = () => state.sprints[state.selected];

// --- L√≥gica Principal de Dados (Firebase) ---
onSnapshot(sprintsCol, snapshot => {
    const remoteSprints = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
    if (remoteSprints.length === 0) {
        console.log("Nenhuma sprint. Criando a primeira de exemplo.");
        createInitialSprint();
        return;
    }
    state.sprints = remoteSprints.sort((a, b) => a.createdAt - b.createdAt);
    if (state.selected >= state.sprints.length) state.selected = state.sprints.length - 1;
    console.log("Dados sincronizados!", state.sprints);
    renderAllUI();
});

async function createInitialSprint() {
    const todayISO = new Date().toISOString().slice(0, 10);
    const newSprint = {
        name: 'Sprint 1', start: todayISO, end: addDays(todayISO, 14), createdAt: Date.now(),
        epics: [ {id: cryptoRandomId(), name: 'Sa√∫de'}, {id: cryptoRandomId(), name: 'Lazer'}, {id: cryptoRandomId(), name: 'Trabalho'} ],
        tasks: [ { id: cryptoRandomId(), title: 'Configurar o tracker com Firebase', epicId: null, tags: ['config'], assignee: 'Caio', points: 5, status: 'done', notes: '' } ]
    };
    await setDoc(doc(sprintsCol), newSprint);
}

async function updateCurrentSprintInFirebase() {
    const sp = currentSprint();
    if (!sp || !sp.id) return;
    const { id, ...sprintData } = sp;
    await setDoc(doc(db, 'sprints', sp.id), sprintData, { merge: true });
    console.log(`Sprint "${sp.name}" atualizada.`);
}

// --- Fun√ß√µes de Renderiza√ß√£o da UI ---
function renderAllUI() {
    const sp = currentSprint();
    if (!sp) return;
    renderSprintOptions();
    renderEpicUIs();
    renderHeader();
    renderStats();
    renderBoard();
}

function renderSprintOptions() {
    const selectedSprintId = currentSprint()?.id;
    $('#sprintSelect').innerHTML = state.sprints.map((sp, idx) =>
        `<option value="${idx}" ${sp.id === selectedSprintId ? 'selected' : ''}>${sp.name}</option>`
    ).join('');
}

function renderEpicUIs() {
    const sp = currentSprint();
    const epics = sp.epics || [];
    const epicOptions = epics.map(e => `<option value="${e.id}">${escapeHtml(e.name)}</option>`).join('');
    $('#epicFilter').innerHTML = `<option value="all">Todos os √©picos</option>${epicOptions}`;
    $('#epicSelect').innerHTML = `<option value="">√âpico‚Ä¶</option>${epicOptions}`;
    $('#editForm select[name="epicId"]').innerHTML = epicOptions;
    $('#epicList').innerHTML = epics.map(e => `<span class="badge epic epic-chip"><span>${escapeHtml(e.name)}</span><button title="Excluir √©pico" data-action="del-epic" data-id="${e.id}">√ó</button></span>`).join('');
}

function renderHeader() {
    const sp = currentSprint();
    const dl = { total: Math.ceil((new Date(sp.end) - new Date(sp.start)) / 864e5), left: Math.max(0, Math.ceil((new Date(sp.end) - new Date()) / 864e5)) };
    $('#sprintTitle').textContent = `üèÅ ${sp.name}`;
    $('#dateBadge').innerHTML = `‚è≥ ${fmtDate(sp.start)} ‚Üí ${fmtDate(sp.end)} ¬∑ ${dl.left}/${dl.total} dias restantes`;
}


function renderStats() {
    const sp = currentSprint();
    const tasks = sp.tasks || [];
    const totals = calcTotals(tasks);
    const { Caio: caio, Aline: aline } = totals.byAssignee;

    // Build the per-assignee stat cards including Not Done
    $('#stats').innerHTML = [aline, caio].map(b => {
      const pctDone = b.total ? Math.min(100, Math.round((b.done / b.total) * 100)) : 0;
      const pctNotDone = b.total ? Math.min(100, Math.round((b.notdone / b.total) * 100)) : 0;
      const share = totals.total ? Math.round((b.total / totals.total) * 100) : 0;
      return `<div class="stat">
          <div class="muted">${b.who}</div>
          <div class="n">Planejados: ${b.total} pts</div>
          <div class="muted">Entregues: ${b.done} pts ¬∑ N√£o concl.: ${b.notdone} pts</div>
          <div class="muted" style="margin-top:6px">Progresso</div>
          <div class="progress"><div class="bar" style="width:${pctDone}%"></div></div>
          <div class="muted" style="margin-top:4px">Conclus√£o: ${pctDone}%</div>
          <div class="muted" style="margin-top:6px">N√£o conclu√≠das</div>
          <div class="progress"><div class="bar" style="width:${pctNotDone}%"></div></div>
          <div class="muted" style="margin-top:4px">${pctNotDone}% dos pontos</div>
          <div class="muted" style="margin-top:6px">Participa√ß√£o</div>
          <div class="progress"><div class="bar" style="width:${share}%"></div></div>
          <div class="muted" style="margin-top:4px">${share}% dos pontos</div>
        </div>`;
    }).join('');

    const alinePct = aline.total ? Math.round((aline.done / aline.total) * 100) : 0;
    const caioPct = caio.total ? Math.round((caio.done / caio.total) * 100) : 0;
    $('#progressAlineBar').style.width = `${alinePct}%`;
    $('#progressAlinePct').textContent = `${alinePct}%`;
    $('#progressCaioBar').style.width = `${caioPct}%`;
    $('#progressCaioPct').textContent = `${caioPct}%`;
    $('#concluidoAline').textContent = `Conclu√≠do Aline: ${aline.done} pts`;
    $('#concluidoCaio').textContent = `Conclu√≠do Caio: ${caio.done} pts`;

    // Column counters
    $('#todoCount').textContent = tasks.filter(t => t.status === 'todo').length;
    $('#doingCount').textContent = tasks.filter(t => t.status === 'doing').length;
    $('#doneCount').textContent = tasks.filter(t => t.status === 'done').length;
    const notDoneCount = tasks.filter(t => t.status === 'notdone').length;
    const notDoneEl = document.getElementById('notDoneCount');
    if (notDoneEl) notDoneEl.textContent = notDoneCount;
}



function calcTotals(tasks) {
    const fib = n => Number(n) || 0;
    const byAssignee = { Caio: { who: 'Caio', total: 0, done: 0, notdone: 0 }, Aline: { who: 'Aline', total: 0, done: 0, notdone: 0 } };
    tasks.forEach(t => {
      const a = byAssignee[t.assignee];
      if (a) {
        const pts = fib(t.points);
        a.total += pts;
        if (t.status === 'done') a.done += pts;
        if (t.status === 'notdone') a.notdone += pts;
      }
    });
    return { total: byAssignee.Caio.total + byAssignee.Aline.total, byAssignee };
}


function renderBoard() {
    $$('.dropzone').forEach(col => col.innerHTML = '');
    const sp = currentSprint();
    const tasks = (sp.tasks || []).filter(t => $('#epicFilter').value === 'all' || t.epicId === $('#epicFilter').value);
    tasks.sort((a, b) => (a._order || 0) - (b._order || 0));
    tasks.forEach(task => {
        const card = document.createElement('article');
        card.className = `task${task.status === 'done' ? ' done' : ''}`;
        card.draggable = true; card.dataset.id = task.id;
        const epicName = sp.epics.find(e => e.id === task.epicId)?.name || 'Sem √©pico';
        const tagsHTML = (task.tags || []).map(tag => `<span class="badge tag">${escapeHtml(tag)}</span>`).join('');
        let daysInProgressHTML = '';
        if (task.status === 'doing' && task.startedAt) {
            const diffDays = Math.ceil(Math.abs(new Date() - new Date(`${task.startedAt}T00:00:00`)) / 864e5);
            daysInProgressHTML = `<span class="badge warn" style="margin-left: auto;">H√° ${diffDays} dia(s)</span>`;
        }
        let checklistHTML = '';
        if (task.checklist && task.checklist.length > 0) {
            const total = task.checklist.length;
            const done = task.checklist.filter(item => item.done).length;
            const percent = total > 0 ? Math.round((done / total) * 100) : 0;
            checklistHTML = `<div style="margin-top: 8px;"><div class="row-between" style="font-size: 12px; margin-bottom: 4px;"><span class="muted">Checklist</span><span class="muted">${done}/${total} (${percent}%)</span></div><div class="progress"><div class="bar" style="width: ${percent}%;"></div></div></div>`;
        }
        card.innerHTML = `<div class="row-between"><div class="title">${escapeHtml(task.title)}</div><div class="row" style="gap:6px">${daysInProgressHTML}<span class="badge epic">${escapeHtml(epicName)}</span><span class="badge points">${task.points} pts</span><span class="badge assignee">${task.assignee}</span></div></div>${tagsHTML ? `<div class="taglist">${tagsHTML}</div>` : ''}${task.notes ? `<div class="muted" style="font-size:12px;white-space:pre-wrap;margin-top:4px;">${escapeHtml(task.notes)}</div>` : ''}${checklistHTML}`;
        card.addEventListener('dblclick', () => openEdit(task.id));
        makeDraggable(card);
        $(`#${task.status}`).appendChild(card);
    });
}

// --- L√≥gica de Intera√ß√£o do Usu√°rio ---
$('#sprintSelect').addEventListener('change', e => { state.selected = Number(e.target.value); renderAllUI(); });
$('#epicFilter').addEventListener('change', () => renderBoard());

$('#taskForm').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const sp = currentSprint();
    sp.tasks.push({ id: cryptoRandomId(), title: String(fd.get('title')||'').trim(), epicId: fd.get('epicId')||null, tags: String(fd.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean), assignee: fd.get('assignee'), points: Number(fd.get('points')), status: fd.get('status'), notes: '', checklist: [] });
    e.target.reset();
    updateCurrentSprintInFirebase();
});

$('#addSprintBtn').addEventListener('click', () => {
    const last = state.sprints[state.sprints.length - 1];
    const todayISO = new Date().toISOString().slice(0, 10);
    $('#startDate').value = last ? last.end : todayISO;
    $('#endDate').value = last ? addDays(last.end || todayISO, 14) : addDays(todayISO, 14);
    $('#sprintModal').showModal();
});

$('#sprintForm').addEventListener('submit', async e => {
    e.preventDefault();
    const f = new FormData(e.target);
    const prev = currentSprint();
    const newSprint = { name: f.get('name') || 'Sprint', start: f.get('start'), end: f.get('end'), epics: prev?.epics ? JSON.parse(JSON.stringify(prev.epics)) : [], tasks: [], createdAt: Date.now() };
    await setDoc(doc(sprintsCol), newSprint);
    $('#sprintModal').close();
});

$('#addEpicBtn').addEventListener('click', () => {
    const input = $('#newEpicName');
    const name = String(input.value || '').trim();
    if (!name) return;
    const sp = currentSprint();
    if (!sp.epics) sp.epics = [];
    if (sp.epics.some(e => String(e.name).trim().toLowerCase() === name.toLowerCase())) return alert('J√° existe um √©pico com esse nome.');
    sp.epics.push({ id: cryptoRandomId(), name });
    input.value = '';
    updateCurrentSprintInFirebase();
});

$('#epicList').addEventListener('click', e => {
    const btn = e.target.closest('[data-action="del-epic"]');
    if (!btn) return;
    const sp = currentSprint();
    const epic = sp.epics.find(e => e.id === btn.dataset.id);
    if (!epic || !confirm(`Excluir √©pico "${epic.name}"?`)) return;
    sp.epics = sp.epics.filter(e => e.id !== btn.dataset.id);
    sp.tasks.forEach(t => { if (t.epicId === btn.dataset.id) t.epicId = null; });
    updateCurrentSprintInFirebase();
});

function openEdit(id) {
    const sp = currentSprint();
    const t = sp.tasks.find(x => x.id === id); if (!t) return;
    const f = $('#editForm');
    f.dataset.id = id;
    f.title.value = t.title; f.assignee.value = t.assignee; f.points.value = String(t.points); f.status.value = t.status; f.notes.value = t.notes || '';
    renderEpicUIs();
    f.querySelector('select[name="epicId"]').value = t.epicId || '';
    f.querySelector('input[name="tags"]').value = (t.tags || []).join(', ');
    renderChecklistInModal(t);
    $('#editModal').showModal();
}

// --- FUN√á√ïES ESPEC√çFICAS DO CHECKLIST ---
function renderChecklistInModal(task) {
    const container = $('#checklistContainer');
    container.innerHTML = '';
    if (!task.checklist) task.checklist = [];
    const total = task.checklist.length;
    const done = task.checklist.filter(item => item.done).length;
    const percent = total > 0 ? Math.round((done / total) * 100) : 0;
    $('#checklistTitle').textContent = `Checklist (${done}/${total} - ${percent}%)`;
    task.checklist.forEach((item, index) => {
        const itemEl = document.createElement('div');
        itemEl.className = 'row';
        itemEl.style.justifyContent = 'space-between';
        itemEl.style.padding = '4px 0';
        itemEl.innerHTML = `<label class="row" style="gap: 8px; align-items: center; flex: 1; cursor: pointer;"><input type="checkbox" data-index="${index}" ${item.done ? 'checked' : ''}><span style="${item.done ? 'text-decoration: line-through; opacity: 0.7;' : ''}">${escapeHtml(item.text)}</span></label><button type="button" class="btn ghost" data-index="${index}" style="padding: 2px 6px; color: var(--danger);">√ó</button>`;
        itemEl.querySelector('input[type="checkbox"]').addEventListener('change', e => {
            task.checklist[index].done = e.target.checked;
            renderChecklistInModal(task);
        });
        itemEl.querySelector('button').addEventListener('click', () => {
            task.checklist.splice(index, 1);
            renderChecklistInModal(task);
        });
        container.appendChild(itemEl);
    });
}

$('#addChecklistItemBtn').addEventListener('click', () => {
    const taskId = $('#editForm').dataset.id;
    const sp = currentSprint();
    const task = sp.tasks.find(t => t.id === taskId);
    const input = $('#newChecklistItem');
    const text = input.value.trim();
    if (text && task) {
        if (!task.checklist) task.checklist = [];
        task.checklist.push({ id: cryptoRandomId(), text: text, done: false });
        input.value = '';
        renderChecklistInModal(task);
    }
});

$('#newChecklistItem').addEventListener('keydown', e => {
    if (e.key === 'Enter') {
        e.preventDefault();
        $('#addChecklistItemBtn').click();
    }
});

// --- L√ìGICA DO MODAL DE EDI√á√ÉO ---
$('#editForm').addEventListener('submit', e => {
    e.preventDefault();
    const f = e.target;
    const id = f.dataset.id;
    const sp = currentSprint();
    const item = sp.tasks.find(x => x.id === id);
    if (!item) return;
    Object.assign(item, { title: String(f.title.value || '').trim(), assignee: f.assignee.value, points: Number(f.points.value), status: f.status.value, notes: f.notes.value, epicId: f.querySelector('select[name="epicId"]').value || null, tags: f.querySelector('input[name="tags"]').value.split(',').map(s => s.trim()).filter(Boolean) });
    if (item.status === 'done' && !item.doneAt) item.doneAt = new Date().toISOString().slice(0, 10);
    if (item.status !== 'done' && item.doneAt) delete item.doneAt;
    updateCurrentSprintInFirebase();
    $('#editModal').close();
});

$('#editForm').addEventListener('click', e => {
    const value = e.target.getAttribute('value');
    if (value === 'cancel') {
        $('#editModal').close();
    } else if (value === 'delete') {
        if (confirm('Tem certeza de que deseja excluir esta tarefa?')) {
            const id = $('#editForm').dataset.id;
            const sp = currentSprint();
            sp.tasks = sp.tasks.filter(t => t.id !== id);
            $('#editModal').close();
            updateCurrentSprintInFirebase();
        }
    }
});

// --- L√≥gica de Drag and Drop ---
function makeDraggable(card) {
    card.addEventListener('dragstart', () => card.classList.add('dragging'));
    card.addEventListener('dragend', () => card.classList.remove('dragging'));
}
$$('.dropzone').forEach(zone => {
    zone.addEventListener('dragover', e => {
        e.preventDefault();
        const after = getDragAfterElement(zone, e.clientY);
        zone.insertBefore($('.task.dragging'), after);
    });
    zone.addEventListener('drop', e => {
        e.preventDefault();
        const dragging = $('.task.dragging');
        if (!dragging) return;
        moveTask(dragging.dataset.id, zone.parentElement.dataset.col);
        persistOrder(zone.parentElement.dataset.col);
    });
});
function getDragAfterElement(container, y) {
    const draggables = [...container.querySelectorAll('.task:not(.dragging)')];
    return draggables.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function persistOrder(status) {
    const sp = currentSprint();
    const ids = $$(`#${status} .task`).map(el => el.dataset.id);
    sp.tasks.forEach(t => { if (t.status === status) t._order = ids.indexOf(t.id); });
    updateCurrentSprintInFirebase();
}

function moveTask(id, newStatus) {
    const sp = currentSprint();
    const t = sp.tasks.find(x => x.id === id);
    if (!t) return;
    t.status = newStatus;
    if (newStatus === 'doing' && !t.startedAt) t.startedAt = new Date().toISOString().slice(0, 10);
    else if (newStatus !== 'doing') delete t.startedAt;
    if (newStatus === 'done' && !t.doneAt) t.doneAt = new Date().toISOString().slice(0, 10);
    if (newStatus !== 'done' && t.doneAt) delete t.doneAt;
    // Not done should not carry doneAt
    if (newStatus === 'notdone') { if (t.doneAt) delete t.doneAt; }
    updateCurrentSprintInFirebase();
}


// --- Bot√µes de Backup e Reset ---
$('#exportBtn').addEventListener('click', () => {
    const data = JSON.stringify(state.sprints, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = 'sprint-tracker-backup.json';
    a.click();
    URL.revokeObjectURL(url);
});

// MELHORIA: Bot√£o agora deleta apenas a sprint atual
$('#resetBtn').addEventListener('click', async () => {
    const sp = currentSprint();
    if (!sp) return;
    if (state.sprints.length <= 1) {
        return alert("N√£o √© poss√≠vel excluir a √∫ltima sprint.");
    }

    if (confirm(`Tem certeza de que deseja excluir a sprint "${sp.name}"? Esta a√ß√£o n√£o pode ser desfeita.`)) {
        await deleteDoc(doc(db, 'sprints', sp.id));
        // Seleciona a primeira sprint para evitar erros.
        state.selected = 0; 
        console.log(`Sprint "${sp.name}" foi exclu√≠da.`);
    }
});

// --- Edit Sprint Name (inline via button prompt) ---
const editBtn = document.getElementById('editSprintNameBtn');
if (editBtn) {
  editBtn.addEventListener('click', () => {
      const sp = currentSprint();
      if (!sp) return;
      const newName = prompt('Novo nome da sprint:', sp.name || '');
      if (newName !== null) {
          const trimmed = String(newName).trim();
          if (trimmed && trimmed !== sp.name) {
              sp.name = trimmed;
              updateCurrentSprintInFirebase();
              renderHeader();
              renderSprintOptions();
          }
      }
  });
}

// Also allow double-click on the title to rename quickly
const sprintTitleEl = document.getElementById('sprintTitle');
if (sprintTitleEl) {
  sprintTitleEl.style.cursor = 'text';
  sprintTitleEl.title = 'D√™ um duplo clique para renomear';
  sprintTitleEl.addEventListener('dblclick', () => {
      const sp = currentSprint();
      if (!sp) return;
      const newName = prompt('Novo nome da sprint:', sp.name || '');
      if (newName !== null) {
          const trimmed = String(newName).trim();
          if (trimmed && trimmed !== sp.name) {
              sp.name = trimmed;
              updateCurrentSprintInFirebase();
              renderHeader();
              renderSprintOptions();
          }
      }
  });
}

</script>

</body>
</html>


// --- Edit Sprint Name (inline via button prompt) ---
const editBtn = document.getElementById('editSprintNameBtn');
if (editBtn) {
  editBtn.addEventListener('click', () => {
      const sp = currentSprint();
      if (!sp) return;
      const newName = prompt('Novo nome da sprint:', sp.name || '');
      if (newName !== null) {
          const trimmed = String(newName).trim();
          if (trimmed && trimmed !== sp.name) {
              sp.name = trimmed;
              updateCurrentSprintInFirebase();
              renderHeader();
              renderSprintOptions();
          }
      }
  });
}

// Also allow double-click on the title to rename quickly
const sprintTitleEl = document.getElementById('sprintTitle');
if (sprintTitleEl) {
  sprintTitleEl.style.cursor = 'text';
  sprintTitleEl.title = 'D√™ um duplo clique para renomear';
  sprintTitleEl.addEventListener('dblclick', () => {
      const sp = currentSprint();
      if (!sp) return;
      const newName = prompt('Novo nome da sprint:', sp.name || '');
      if (newName !== null) {
          const trimmed = String(newName).trim();
          if (trimmed && trimmed !== sp.name) {
              sp.name = trimmed;
              updateCurrentSprintInFirebase();
              renderHeader();
              renderSprintOptions();
          }
      }
  });
}

</script>

</body>
</html>
