<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sprint Tracker ‚Äì Aline & Caio - V2</title>
  <style>
    :root{
      --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e8ecf1; --accent:#6ee7b7; --accent2:#60a5fa; --danger:#f87171; --warn:#fbbf24;
      --card:#1e2338; --border:#2b3151;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica,Arial,sans-serif;background:radial-gradient(1200px 600px at 20% -10%,#1c2040 0%,transparent 65%),radial-gradient(1000px 800px at 120% 10%,#112033 0%,transparent 60%),var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(15,18,32,.95),rgba(15,18,32,.75));backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    h1{font-size:20px;margin:0}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border:1px solid var(--border);border-radius:12px;background:var(--panel);color:var(--text)}
    select,input,button,textarea{background:var(--panel);border:1px solid var(--border);color:var(--text);border-radius:10px;padding:9px 10px;outline:none}
    select:focus,input:focus,textarea:focus{border-color:var(--accent2);box-shadow:0 0 0 2px rgba(96,165,250,.25)}
    button{cursor:pointer}
    .btn{border:1px solid var(--border);background:var(--card)}
    .btn.primary{background:linear-gradient(180deg,#1f8b6a,#146a53);border-color:#2f9b7b}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn.ghost{background:transparent}
    .btn.warn{background:#3a2c11;border-color:#6b4c12;color:#ffd88a}
    .btn.danger{background:#3a1717;border-color:#6b1f1f;color:#ffb3b3}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    @media (min-width:900px){.grid{grid-template-columns:320px 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .card h3{margin:0 0 8px;font-size:16px}
    .kanban{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
    @media (min-width:900px){.kanban{grid-template-columns:repeat(3,1fr)}}
    .col{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:10px;min-height:240px}
    .col h4{margin:4px 6px 8px;font-size:14px;color:var(--muted)}
    .task{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:10px;margin:8px;display:grid;gap:8px;box-shadow:0 2px 0 rgba(0,0,0,.2)}
    .task.dragging{opacity:.6;outline:2px dashed var(--accent2)}
    .col.dragover{outline:2px dashed var(--accent2)}
    .row-between{display:flex;justify-content:space-between;align-items:center}
    .badge{font-size:12px; padding:4px 8px; border-radius:999px;border:1px solid var(--border);background:#11162a; color:#c9d3e3}
    .points{background:#1b2b1e;color:#b7fdd4;border-color:#214e35}
    .assignee{background:#162338;color:#cfe3ff;border-color:#274168}
    .done .title{text-decoration:line-through;color:#a7b0c0}
    .muted{color:var(--muted)}
    .stats{display:grid;gap:16px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));}
    .stat{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    .stat .n{font-size:20px;font-weight:700}
    .progress{height:10px;border-radius:999px;background:#121527;border:1px solid var(--border);overflow:hidden}
    .bar{height:100%;background:linear-gradient(90deg,#60a5fa,#6ee7b7)}
    .epic{background:#30224a;border-color:#523d7e;color:#e6d8ff}
    .tag{background:#26343a;border-color:#35606b;color:#c7f2ff;font-size:11px;padding:3px 6px}
    .taglist{display:flex;flex-wrap:wrap;gap:6px}
    .epic-chip{display:inline-flex;align-items:center;gap:6px}
    .epic-chip button{all:unset;cursor:pointer;font-weight:700;line-height:1;padding:0 6px;border-radius:8px;color:#fbb6b6}
    .epic-chip button:hover{background:#44222a}
    dialog{border:none;border-radius:16px;background:var(--panel);color:var(--text);box-shadow:0 20px 60px rgba(0,0,0,.45);}
    .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
    .sr{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .pill-container { margin-top: 16px; gap: 12px; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:10px;align-items:center">
          <h1>üèÅ Sprint Tracker ‚Äî Aline & Caio - V2</h1>
          <span id="dateBadge" class="pill">Carregando‚Ä¶</span>
        </div>
        <div class="row">
          <select id="sprintSelect" title="Selecionar sprint"></select>
          <select id="epicFilter" title="Filtrar por √©pico"><option value="all">Todos os √©picos</option></select>
          <button class="btn" id="addSprintBtn">+ Nova Sprint</button>
          <button class="btn" id="exportBtn" title="Exportar JSON">Exportar</button>
          <label class="btn ghost" style="cursor:pointer">Importar
            <input id="importInput" type="file" accept="application/json" style="display:none" />
          </label>
          <button class="btn warn" id="resetBtn" title="Limpar dados do Firebase">Limpar</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="display:grid;gap:14px">
    <section class="grid">
      <div class="card">
        <h3>Adicionar tarefa</h3>
        <form id="taskForm" class="row" style="gap:10px">
          <input required name="title" placeholder="T√≠tulo da tarefa" style="flex:1"/>
          <select name="epicId" id="epicSelect" required>
            <option value="">√âpico‚Ä¶</option>
          </select>
          <input name="tags" placeholder="tags (v√≠rgulas)" style="min-width:180px" />
          <select name="assignee" required> <option value="Aline">Aline</option> <option value="Caio">Caio</option> </select>
          <select name="points" required> <option value="0">0</option> <option value="1">1</option> <option value="2">2</option> <option value="3">3</option> <option value="5" selected>5</option> <option value="8">8</option> <option value="13">13</option> <option value="21">21</option> <option value="34">34</option> </select>
          <select name="status" required> <option value="todo">A fazer</option> <option value="doing">Em andamento</option> <option value="done">Conclu√≠da</option> </select>
          <button class="btn primary" type="submit">Adicionar</button>
        </form>
        <p class="muted" style="margin:8px 4px 0">Pontua√ß√£o usa <b>Fibonacci</b>. Tarefas pertencem a um <b>√âpico</b> e podem ter <b>tags</b>.</p>
      </div>
      <div class="card">
        <h3>Resumo da sprint</h3>
        <div class="stats" id="stats"></div>
        <div style="margin-top:8px">
          <div class="row-between"><span class="muted">Progresso Aline</span><span id="progressAlinePct">0%</span></div>
          <div class="progress"><div id="progressAlineBar" class="bar" style="width:0%"></div></div>
          <div class="row-between" style="margin-top:6px"><span class="muted">Progresso Caio</span><span id="progressCaioPct">0%</span></div>
          <div class="progress"><div id="progressCaioBar" class="bar" style="width:0%"></div></div>
          <div class="row pill-container">
            <span class="pill" id="concluidoAline">Conclu√≠do Aline: 0 pts</span>
            <span class="pill" id="concluidoCaio">Conclu√≠do Caio: 0 pts</span>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h3>√âpicos</h3>
      <div id="epicList" class="taglist" style="margin-bottom:8px"></div>
      <div class="row" style="gap:8px">
        <input id="newEpicName" placeholder="Novo √©pico (ex.: Sa√∫de)"/>
        <button class="btn" id="addEpicBtn">Adicionar √©pico</button>
      </div>
    </section>

    <section class="kanban">
      <div class="col" data-col="todo"> <h4>üóÇÔ∏è A fazer (<span class="muted" id="todoCount">0</span>)</h4> <div class="dropzone" id="todo"></div> </div>
      <div class="col" data-col="doing"> <h4>üöß Em andamento (<span class="muted" id="doingCount">0</span>)</h4> <div class="dropzone" id="doing"></div> </div>
      <div class="col" data-col="done"> <h4>‚úÖ Conclu√≠da (<span class="muted" id="doneCount">0</span>)</h4> <div class="dropzone" id="done"></div> </div>
    </section>
  </main>

  <dialog id="editModal">
    <form method="dialog" id="editForm" style="min-width:320px;max-width:520px;padding:12px">
      <h3>Editar tarefa</h3>
      <input name="title" placeholder="T√≠tulo" style="width:100%;margin:6px 0" />
      <div class="row" style="gap:8px;margin:6px 0">
        <select name="assignee"> <option value="Aline">Aline</option> <option value="Caio">Caio</option> </select>
        <select name="points"> <option>0</option><option>1</option><option>2</option><option>3</option><option>5</option><option>8</option><option>13</option><option>21</option><option>34</option> </select>
        <select name="status"> <option value="todo">A fazer</option> <option value="doing">Em andamento</option> <option value="done">Conclu√≠da</option> </select>
      </div>
      <div class="row" style="gap:8px;margin:6px 0">
        <select name="epicId"></select>
        <input name="tags" placeholder="tags (v√≠rgulas)" />
      </div>
      <textarea name="notes" rows="3" placeholder="Notas / crit√©rio de aceite (opcional)" style="width:100%;margin:6px 0"></textarea>
      <div class="modal-actions">
        <button class="btn danger" value="delete">Excluir</button>
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn primary" value="save">Salvar</button>
      </div>
    </form>
  </dialog>

  <dialog id="sprintModal">
    <form method="dialog" id="sprintForm" style="min-width:320px;max-width:520px;padding:12px">
      <h3>Nova Sprint</h3>
      <label>Nome<input name="name" placeholder="Sprint X" style="width:100%;margin:6px 0" required></label>
      <div class="row" style="gap:8px;margin:6px 0">
        <label class="sr" for="startDate">In√≠cio</label> <input id="startDate" name="start" type="date" required>
        <label class="sr" for="endDate">Fim</label> <input id="endDate" name="end" type="date" required>
      </div>
      <div class="modal-actions">
        <button class="btn" value="cancel">Cancelar</button>
        <button class="btn primary" value="create">Criar</button>
      </div>
    </form>
  </dialog>

<script type="module">
  // --- In√≠cio da Configura√ß√£o do Firebase ---
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
  import { getFirestore, collection, doc, onSnapshot, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBjUoks9OQxUQ6_rdUSXE-ZLzjQrjLNVh8",
    authDomain: "sprint-tracker-aline-caio.firebaseapp.com",
    projectId: "sprint-tracker-aline-caio",
    storageBucket: "sprint-tracker-aline-caio.appspot.com",
    messagingSenderId: "1096785458487",
    appId: "1:1096785458487:web:c89269c1c00d2a9b9316b2"
  };

  // Initialize Firebase and Firestore
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  // --- Fim da Configura√ß√£o do Firebase ---

  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  let state = { sprints: [], selected: 0 };
  const sprintsCol = collection(db, 'sprints');

  onSnapshot(sprintsCol, snapshot => {
    const remoteSprints = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
    if (remoteSprints.length === 0) {
      console.log("Nenhuma sprint encontrada. Criando a primeira sprint de exemplo.");
      createInitialSprint();
      return;
    }
    state.sprints = remoteSprints.sort((a, b) => a.createdAt - b.createdAt);
    if (state.selected >= state.sprints.length) {
      state.selected = state.sprints.length - 1;
    }
    console.log("Dados sincronizados do Firebase!", state.sprints);
    renderAllUI();
  });

  async function createInitialSprint() {
    const todayISO = new Date().toISOString().slice(0, 10);
    const newSprint = {
      name: 'Sprint 1',
      start: todayISO,
      end: addDays(todayISO, 14),
      epics: [ {id: cryptoRandomId(), name: 'Sa√∫de'}, {id: cryptoRandomId(), name: 'Lazer'}, {id: cryptoRandomId(), name: 'Estudos'}, {id: cryptoRandomId(), name: 'Trabalho'} ],
      tasks: [ { id: cryptoRandomId(), title: 'Planejar Sprint 1 e definir DoD', epicId: null, tags: ['planejamento'], assignee: 'Caio', points: 3, status: 'todo', notes: '' } ],
      createdAt: Date.now()
    };
    const newSprintRef = doc(sprintsCol);
    await setDoc(newSprintRef, newSprint);
    state.selected = 0;
  }

  const sprintSelect = $('#sprintSelect');
  const dateBadge = $('#dateBadge');
  const statsEl = $('#stats');

  const currentSprint = () => state.sprints[state.selected];

  function renderAllUI() {
    if (!currentSprint()) {
      console.warn("Nenhuma sprint para renderizar.");
      return;
    }
    renderSprintOptions();
    renderEpicUIs();
    renderHeader();
    renderStats();
    renderBoard();
  }

  async function updateCurrentSprintInFirebase() {
    const sp = currentSprint();
    if (!sp || !sp.id) return;
    const sprintRef = doc(db, 'sprints', sp.id);
    const { id, ...sprintData } = sp; // Remove ID before saving
    await setDoc(sprintRef, sprintData, { merge: true });
    console.log("Sprint atualizada no Firebase.");
  }

  $('#taskForm').addEventListener('submit', e => {
    e.preventDefault();
    const fd = new FormData(e.target);
    const t = { id: cryptoRandomId(), title: String(fd.get('title') || '').trim(), epicId: fd.get('epicId') || null, tags: String(fd.get('tags') || '').split(',').map(s => s.trim()).filter(Boolean), assignee: fd.get('assignee'), points: Number(fd.get('points')), status: fd.get('status'), notes: '' };
    const sp = currentSprint();
    if (!sp.tasks) sp.tasks = [];
    sp.tasks.push(t);
    e.target.reset();
    updateCurrentSprintInFirebase();
  });

  function moveTask(id, newStatus) {
    const sp = currentSprint();
    const t = sp.tasks.find(x => x.id === id);
    if (!t) return;
    t.status = newStatus;
    if (newStatus === 'doing' && !t.startedAt) t.startedAt = new Date().toISOString().slice(0, 10);
    else if (newStatus !== 'doing') delete t.startedAt;
    if (newStatus === 'done' && !t.doneAt) t.doneAt = new Date().toISOString().slice(0, 10);
    if (newStatus !== 'done' && t.doneAt) delete t.doneAt;
    updateCurrentSprintInFirebase();
  }

  $('#editForm').addEventListener('click', e => {
    const action = e.target.value;
    if (!action) return;
    const id = e.currentTarget.dataset.id;
    const sp = currentSprint();
    const idx = sp.tasks.findIndex(x => x.id === id);
    if (idx < 0) return;
    if (action === 'delete') {
      sp.tasks.splice(idx, 1);
      $('#editModal').close();
      updateCurrentSprintInFirebase();
    } else if (action === 'save') {
      const f = $('#editForm');
      const item = sp.tasks[idx];
      Object.assign(item, { title: String(f.title.value || '').trim(), assignee: f.assignee.value, points: Number(f.points.value), status: f.status.value, notes: f.notes.value, epicId: f.querySelector('select[name="epicId"]').value || null, tags: f.querySelector('input[name="tags"]').value.split(',').map(s => s.trim()).filter(Boolean) });
      if (item.status === 'done' && !item.doneAt) item.doneAt = new Date().toISOString().slice(0, 10);
      if (item.status !== 'done' && item.doneAt) delete item.doneAt;
      $('#editModal').close();
      updateCurrentSprintInFirebase();
    } else if (action === 'cancel') {
      $('#editModal').close();
    }
  });

  $('#addSprintBtn').addEventListener('click', () => {
    const spf = $('#sprintForm');
    spf.reset();
    const last = state.sprints[state.sprints.length - 1];
    const todayISO = new Date().toISOString().slice(0, 10);
    $('#startDate').value = last ? last.end : todayISO;
    $('#endDate').value = last ? addDays(last.end, 14) : addDays(todayISO, 14);
    $('#sprintModal').showModal();
  });

  $('#sprintForm').addEventListener('click', async e => {
    if (e.target.value !== 'create') return;
    const f = new FormData($('#sprintForm'));
    const prev = currentSprint();
    const newSprint = { name: f.get('name') || 'Sprint', start: f.get('start'), end: f.get('end'), epics: prev?.epics ? JSON.parse(JSON.stringify(prev.epics)) : [], tasks: [], createdAt: Date.now() };
    await setDoc(doc(sprintsCol), newSprint);
    state.selected = state.sprints.length;
    $('#sprintModal').close();
  });

  $('#addEpicBtn').addEventListener('click', () => {
    const input = $('#newEpicName');
    const name = String(input.value || '').trim();
    if (!name) return;
    const sp = currentSprint();
    if (!sp.epics) sp.epics = [];
    if (sp.epics.some(e => String(e.name).trim().toLowerCase() === name.toLowerCase())) {
      alert('J√° existe um √©pico com esse nome.');
      return;
    }
    sp.epics.push({ id: cryptoRandomId(), name });
    input.value = '';
    updateCurrentSprintInFirebase();
  });

  $('#epicList').addEventListener('click', e => {
    const btn = e.target.closest('[data-action="del-epic"]');
    if (!btn) return;
    const { id } = btn.dataset;
    const sp = currentSprint();
    if (!sp?.epics) return;
    const epic = sp.epics.find(e => e.id === id);
    if (!epic || !confirm(`Excluir √©pico "${epic.name}"? As tarefas vinculadas ficar√£o sem √©pico.`)) return;
    sp.epics = sp.epics.filter(e => e.id !== id);
    sp.tasks.forEach(t => { if (t.epicId === id) t.epicId = null; });
    updateCurrentSprintInFirebase();
  });

  function cryptoRandomId() {
    try { return crypto.randomUUID(); } catch (e) { return `id-${Math.random().toString(36).slice(2)}`; }
  }

  const fmtDate = iso => new Date(`${iso}T00:00:00`).toLocaleDateString('pt-BR');

  function daysLeft(start, end) {
    const s = new Date(`${start}T00:00:00`);
    const e = new Date(`${end}T23:59:59`);
    const now = new Date();
    return { total: Math.ceil((e - s) / 864e5), left: Math.max(0, Math.ceil((e - now) / 864e5)) };
  }

  function renderHeader() {
    const sp = currentSprint();
    if (!sp) return;
    const dl = daysLeft(sp.start, sp.end);
    dateBadge.innerHTML = `‚è≥ ${fmtDate(sp.start)} ‚Üí ${fmtDate(sp.end)} ¬∑ ${dl.left}/${dl.total} dias restantes`;
  }

  function renderStats() {
    const sp = currentSprint();
    if (!sp) return;
    const totals = calcTotals(sp.tasks || []);
    const { Caio: caio, Aline: aline } = totals.byAssignee;
    statsEl.innerHTML = [aline, caio].map(b => {
      const pct = b.total ? Math.min(100, Math.round((b.done / b.total) * 100)) : 0;
      const share = totals.total ? Math.round((b.total / totals.total) * 100) : 0;
      return `<div class="stat">
        <div class="muted">${b.who}</div>
        <div class="n">Planejados: ${b.total} pts</div>
        <div class="muted">Entregues: ${b.done} pts</div>
        <div class="muted" style="margin-top:6px">Progresso</div>
        <div class="progress"><div class="bar" style="width:${pct}%"></div></div>
        <div class="muted" style="margin-top:4px">Conclus√£o: ${pct}%</div>
        <div class="muted" style="margin-top:6px">Participa√ß√£o na sprint</div>
        <div class="progress"><div class="bar" style="width:${share}%"></div></div>
        <div class="muted" style="margin-top:4px">${share}% dos pontos planejados</div>
      </div>`;
    }).join('');
    const alinePct = aline.total ? Math.round((aline.done / aline.total) * 100) : 0;
    const caioPct = caio.total ? Math.round((caio.done / caio.total) * 100) : 0;
    $('#progressAlineBar').style.width = `${alinePct}%`;
    $('#progressAlinePct').textContent = `${alinePct}%`;
    $('#progressCaioBar').style.width = `${caioPct}%`;
    $('#progressCaioPct').textContent = `${caioPct}%`;
    $('#concluidoAline').textContent = `Conclu√≠do Aline: ${aline.done} pts`;
    $('#concluidoCaio').textContent = `Conclu√≠do Caio: ${caio.done} pts`;
    const tasks = sp.tasks || [];
    $('#todoCount').textContent = tasks.filter(t => t.status === 'todo').length;
    $('#doingCount').textContent = tasks.filter(t => t.status === 'doing').length;
    $('#doneCount').textContent = tasks.filter(t => t.status === 'done').length;
  }

  function calcTotals(tasks) {
    const fib = n => Number(n) || 0;
    const byAssignee = { Caio: { who: 'Caio', total: 0, done: 0 }, Aline: { who: 'Aline', total: 0, done: 0 } };
    tasks.forEach(t => {
      const a = byAssignee[t.assignee];
      if (a) {
        a.total += fib(t.points);
        if (t.status === 'done') a.done += fib(t.points);
      }
    });
    const total = byAssignee.Caio.total + byAssignee.Aline.total;
    return { total, byAssignee };
  }

  function renderBoard() {
    $$('.dropzone').forEach(col => col.innerHTML = '');
    const sp = currentSprint();
    if (!sp) return;
    const tasks = sp.tasks || [];
    const filteredTasks = tasks.filter(t => $('#epicFilter').value === 'all' || t.epicId === $('#epicFilter').value);
    filteredTasks.sort((a, b) => (a._order || 0) - (b._order || 0));
    filteredTasks.forEach(task => {
      const card = document.createElement('article');
      card.className = `task${task.status === 'done' ? ' done' : ''}`;
      card.draggable = true;
      card.dataset.id = task.id;
      const epicName = epicNameById(task.epicId) || 'Sem √©pico';
      const tagsHTML = (task.tags || []).map(tag => `<span class="badge tag">${escapeHtml(tag)}</span>`).join('');
      let daysInProgressHTML = '';
      if (task.status === 'doing' && task.startedAt) {
        const diffDays = Math.ceil(Math.abs(new Date() - new Date(`${task.startedAt}T00:00:00`)) / 864e5);
        daysInProgressHTML = `<span class="badge warn" style="margin-left: auto;">H√° ${diffDays} dia(s)</span>`;
      }
      card.innerHTML = `<div class="row-between">
          <div class="title">${escapeHtml(task.title)}</div>
          <div class="row" style="gap:6px">${daysInProgressHTML}<span class="badge epic">${escapeHtml(epicName)}</span><span class="badge points">${task.points} pts</span><span class="badge assignee">${task.assignee}</span></div>
        </div>
        ${tagsHTML ? `<div class="taglist">${tagsHTML}</div>` : ''}
        ${task.notes ? `<div class="muted" style="font-size:12px;white-space:pre-wrap">${escapeHtml(task.notes)}</div>` : ''}`;
      card.addEventListener('dblclick', () => openEdit(task.id));
      makeDraggable(card);
      $(`#${task.status}`).appendChild(card);
    });
  }

  sprintSelect.addEventListener('change', e => {
    state.selected = Number(e.target.value);
    renderAllUI();
  });

  $('#exportBtn').addEventListener('click', () => {
    const data = JSON.stringify(state, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sprint-tracker-backup.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  $('#importInput').disabled = true;

  $('#resetBtn').addEventListener('click', async () => {
    if (confirm('Tem certeza de que deseja limpar TODOS os dados do Firebase? Esta a√ß√£o n√£o pode ser desfeita.')) {
      for (const sp of state.sprints) {
        await deleteDoc(doc(db, 'sprints', sp.id));
      }
      console.log("Todos os dados foram limpos.");
    }
  });

  const addDays = (iso, n) => {
    const d = new Date(`${iso}T00:00:00`);
    d.setDate(d.getDate() + n);
    return d.toISOString().slice(0, 10);
  };

  function makeDraggable(card) {
    card.addEventListener('dragstart', () => card.classList.add('dragging'));
    card.addEventListener('dragend', () => card.classList.remove('dragging'));
  }

  $$('.dropzone').forEach(zone => {
    zone.addEventListener('dragover', e => {
      e.preventDefault();
      zone.closest('.col').classList.add('dragover');
      const dragging = $('.task.dragging');
      if (!dragging) return;
      const after = getDragAfterElement(zone, e.clientY);
      zone.insertBefore(dragging, after);
    });
    zone.addEventListener('dragleave', () => zone.closest('.col').classList.remove('dragover'));
    zone.addEventListener('drop', e => {
      e.preventDefault();
      zone.closest('.col').classList.remove('dragover');
      const dragging = $('.task.dragging');
      if (!dragging) return;
      moveTask(dragging.dataset.id, zone.id);
      persistOrder(zone.id);
    });
  });

  function getDragAfterElement(container, y) {
    const draggables = [...container.querySelectorAll('.task:not(.dragging)')];
    return draggables.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  function persistOrder(status) {
    const sp = currentSprint();
    const ids = $$(`#${status} .task`).map(el => el.dataset.id);
    sp.tasks.forEach(t => { if (t.status === status) t._order = ids.indexOf(t.id); });
    updateCurrentSprintInFirebase();
  }

  function openEdit(id) {
    const sp = currentSprint();
    const t = sp.tasks.find(x => x.id === id);
    if (!t) return;
    const f = $('#editForm');
    f.dataset.id = id;
    f.title.value = t.title;
    f.assignee.value = t.assignee;
    f.points.value = String(t.points);
    f.status.value = t.status;
    f.notes.value = t.notes || '';
    renderEpicUIs();
    f.querySelector('select[name="epicId"]').value = t.epicId || '';
    f.querySelector('input[name="tags"]').value = (t.tags || []).join(', ');
    $('#editModal').showModal();
  }

  function epicNameById(id) {
    const sp = currentSprint();
    return sp?.epics?.find(e => e.id === id)?.name || null;
  }

  function renderEpicUIs() {
    const sp = currentSprint();
    if (!sp) return;
    const epics = sp.epics || [];
    const epicOptions = epics.map(e => `<option value="${e.id}">${escapeHtml(e.name)}</option>`).join('');
    $('#epicFilter').innerHTML = `<option value="all">Todos os √©picos</option>${epicOptions}`;
    $('#epicSelect').innerHTML = `<option value="">√âpico‚Ä¶</option>${epicOptions}`;
    $('#editForm select[name="epicId"]').innerHTML = epicOptions;
    $('#epicList').innerHTML = epics.map(e => `<span class="badge epic epic-chip"><span>${escapeHtml(e.name)}</span><button title="Excluir √©pico" data-action="del-epic" data-id="${e.id}">√ó</button></span>`).join('');
  }

  $('#epicFilter').addEventListener('change', () => renderBoard());

  const escapeHtml = str => String(str || '').replace(/[&<>"']/g, m => ({ "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#39;" }[m]));
</script>

</body>
</html>
