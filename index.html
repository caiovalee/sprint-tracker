<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Sprint Tracker</title>
<style>
:root{
  --bg:#0f1220; --panel:#171a2b; --muted:#9aa3b2; --text:#e8ecf5;
  --accent:#6ee7b7; --accent2:#60a5fa; --danger:#f87171; --warn:#fbbf24;
  --card:#1e2338; --border:#2b3151;
}
*{box-sizing:border-box}
body{margin:0;font-family:-apple-system,system-ui,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
     background: radial-gradient(120% 80% at 100% 10%,#112033 0%,transparent 60%),
                 radial-gradient(90% 80% at 0% 100%,#182036 0%,transparent 60%),
                 var(--bg); color:var(--text)}
header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,rgba(15,18,32,.9),rgba(15,18,32,.7));
       backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--border)}
.wrap{max-width:1200px;margin:0 auto;padding:14px}
.row{display:flex;gap:8px;align-items:center}
.row-between{display:flex;gap:8px;align-items:center;justify-content:space-between}
.btn{padding:8px 12px;border:1px solid var(--border);background:#0f1427;color:var(--text);border-radius:12px;cursor:pointer}
.btn.primary{background:#1d3a2d;border-color:#264e3c}
.btn.warn{background:#3a2a18;border-color:#574125}
.btn.ghost{background:transparent}
select,input,textarea{background:#0e1426;border:1px solid var(--border);color:var(--text);border-radius:10px;padding:8px}
h1{margin:0}
main .wrap{display:grid;grid-template-columns:1fr;gap:14px}
.panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
.kanban{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:14px}
@media (min-width:900px){.kanban{grid-template-columns:repeat(4,1fr)}}
.col{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:12px;min-height:260px}
.col h4{margin:0 0 8px 0;color:var(--muted)}
.dropzone{display:flex;flex-direction:column;gap:8px;min-height:220px}
.task{background:#121a2f;border:1px solid var(--border);border-radius:12px;padding:10px}
.task.done{opacity:.8}
.task.done .title,
.task[data-status="done"] .title {
  text-decoration: line-through;
  opacity: 0.8;
}
.pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
.pill.ok{border-color:#2e7d32;color:#a5d6a7;background:rgba(46,125,50,.12)}
.pill.warn{border-color:#7c5f1a;color:#f5d08a;background:rgba(245,158,11,.12)}
.pill.danger{border-color:#7c1a1a;color:#f2aaaa;background:rgba(239,68,68,.12)}
.badge{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted)}
.badge.warn{border-color:#5a4918;color:#f7d36e}
.badge.tag{border-color:#374467}
.badge.points{border-color:#2e7d32;color:#a5d6a7;background:rgba(46,125,50,.12)}
.badge.epic{border-color:#374467}
.progress{height:8px;background:#0e1530;border-radius:999px;border:1px solid var(--border);overflow:hidden}
.bar{height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2))}
.n{font-weight:700}
.muted{color:var(--muted)}
.task .title{font-weight:700; font-size:1rem}
.task.done-like .title{text-decoration:line-through; opacity:.8}
.task .notes{color:var(--muted); margin-top:6px; white-space:pre-line; font-size:0.86rem; line-height:1.3}
.task .footer{display:flex;justify-content:space-between;align-items:center;margin-top:8px}
.task .footer .mini{color:var(--muted); font-size:0.86rem}
dialog{background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:16px}
dialog::backdrop{background:rgba(0,0,0,.5)}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
/* Mini calend√°rio */
.minical{display:inline-block;border:1px solid var(--border);border-radius:10px;padding:8px;margin-top:6px}
.minical header{display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;color:var(--muted)}
.minical table{border-collapse:collapse}
.minical th,.minical td{width:28px;height:24px;text-align:center}
.minical td button{width:24px;height:24px;border:1px solid transparent;background:transparent;color:var(--text);border-radius:6px;cursor:pointer}
.minical td button.sel{border-color:#3b82f6;background:rgba(59,130,246,.15)}

/* --- Mobile tweaks (responsive) --- */
@media (max-width: 900px){
  .wrap{padding:12px}
  header .wrap{padding:12px}
  .panel{padding:14px}
  .statsGrid{grid-template-columns:1fr}
}
@media (max-width: 520px){
  header .wrap{gap:8px}
  header .row-between{flex-wrap:wrap; gap:8px; align-items:flex-start}
  .row{gap:6px}
  .btn{padding:6px 8px;border-radius:10px}
  select,input,textarea{font-size:0.95rem;padding:8px 10px}
  h1{font-size:1.35rem}
  #dateBadge{
    font-size:0.82rem; padding:6px 10px; line-height:1.1;
    max-width:70vw; display:inline-block; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
  }
  .panel{border-radius:14px;padding:12px}
  .kanban .col{min-height:140px;padding:10px}
  .task{padding:10px;border-radius:12px}
  .task .title{font-size:0.95rem}
  .task .notes{font-size:0.80rem; line-height:1.3}
  .task .footer .mini{font-size:0.80rem}
  .pill{padding:4px 8px;font-size:0.80rem}
}
@media (max-width: 360px){
  h1{font-size:1.20rem}
  #dateBadge{font-size:0.76rem; max-width:74vw}
}

/* Stats cards like screenshot */
.statsGrid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
@media (min-width:900px){.statsGrid{grid-template-columns:1fr 1fr}}
.statCard{background:#11172d;border:1px solid var(--border);border-radius:14px;padding:14px}
.statCard h4{margin:0 0 4px 0}
.miniLabel{margin-top:6px;color:var(--muted)}
</style>
</head>
<body>
  <header>
    <div class="wrap row-between">
      <div class="row">
        <h1 id="sprintTitle">üöÄ Sprint</h1>
        <button class="btn ghost" id="editSprintBtn" title="Editar sprint">‚úé</button>
        <span id="dateBadge" class="pill">‚Äî</span>
      </div>
      <div class="row">
        <select id="sprintSelect" title="Selecionar sprint"></select>
        <select id="epicFilter" title="Filtrar por √©pico"><option value="all">Todos os √©picos</option></select>
        <button class="btn" id="addSprintBtn">+ Nova Sprint</button>
        <button class="btn" id="exportBtn" title="Exportar JSON (Backup local)">üíæ Backup</button>
        <button class="btn" id="importBtn" title="Importar JSON de backup">üìÅ Importar</button>
        <button class="btn" id="recoverBtn" title="Recuperar dados perdidos" style="background:#3a2a18">üîÑ Recuperar</button>
        <button class="btn" id="diagBtn" title="Diagn√≥stico de conex√£o" style="background:#2a3a3a">üîç Diagn√≥stico</button>
        <input id="importFile" type="file" accept=".json,application/json" style="display:none">
        <button class="btn" id="cloudBtn" title="Configurar sincroniza√ß√£o em tempo real">üåê Cloud</button>
        <button class="btn warn" id="resetBtn" title="Excluir sprint atual">Limpar</button>
        <span id="saveToast" class="pill ok" style="display:none">Salvo!</span>
        <span id="cloudStatus" class="pill warn" style="display:inline-flex">‚ö†Ô∏è Offline</span>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="panel">
      <div class="row" style="gap:14px;align-items:stretch;flex-wrap:wrap">
        <form id="taskForm" class="panel" style="flex:.85;min-width:260px">
          <h3>Adicionar tarefa</h3>
          <div class="row" style="gap:8px;flex-wrap:wrap">
            <input name="title" placeholder="T√≠tulo da tarefa" style="flex:1" required />
            <select name="epicId" id="epicSelect"><option value="">√âpico‚Ä¶</option></select>
          </div>
          <div class="row" style="gap:8px;flex-wrap:wrap;margin-top:6px">
            <input name="tags" placeholder="tags (v√≠rgulas)" style="flex:1" />
            <select name="assignee"><option>Aline</option><option>Caio</option></select>
            <select name="points"><option>1</option><option>2</option><option>3</option><option selected>5</option><option>8</option><option>13</option></select>
            <select name="status"><option value="todo">A fazer</option><option value="doing">Em andamento</option><option value="done">Conclu√≠da</option><option value="notdone">N√£o conclu√≠da</option></select>
            <button class="btn primary">Adicionar</button>
          </div>
        </form>
        <div class="panel" style="flex:1.15;min-width:260px">
          <h3>Resumo da sprint</h3>

          <div>Progresso Aline</div>
          <div class="progress"><div id="progressAlineBar" class="bar" style="width:0%"></div></div>
          <div class="muted" id="progressAlinePct">0%</div>
          <div style="margin-top:6px">Progresso Caio</div>
          <div class="progress"><div id="progressCaioBar" class="bar" style="width:0%"></div></div>
          <div class="muted" id="progressCaioPct">0%</div>

          <div id="statsCards" class="statsGrid"></div>

          <div class="row" style="gap:8px;margin-top:10px">
            <span id="concluidoAline" class="pill">Conclu√≠do Aline: 0 pts</span>
            <span id="concluidoCaio" class="pill">Conclu√≠do Caio: 0 pts</span>
          </div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h3>√âpicos</h3>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <input id="newEpicName" placeholder="Novo √©pico (ex.: Sa√∫de)" style="flex:1;min-width:220px" />
        <button class="btn" id="addEpicBtn">Adicionar √©pico</button>
      </div>
      <div id="epicList" style="margin-top:10px;display:flex;flex-wrap:wrap;gap:8px"></div>
    </section>

    <section class="kanban">
      <div class="col" data-col="todo"><h4>üìù A fazer (<span class="muted" id="todoCount">0</span>)</h4><div class="dropzone" id="todo"></div></div>
      <div class="col" data-col="doing"><h4>üß± Em andamento (<span class="muted" id="doingCount">0</span>)</h4><div class="dropzone" id="doing"></div></div>
      <div class="col" data-col="done"><h4>‚úÖ Conclu√≠da (<span class="muted" id="doneCount">0</span>)</h4><div class="dropzone" id="done"></div></div>
      <div class="col" data-col="notdone"><h4 style="color:#ff7b7b">‚ùå N√£o conclu√≠da (<span class="muted" id="notDoneCount">0</span>)</h4><div class="dropzone" id="notdone"></div></div>
    </section>
  </main>

  <dialog id="sprintModal">
    <form method="dialog" id="sprintForm" style="min-width:320px;max-width:520px;padding:12px">
      <h3>Nova Sprint</h3>
      <label>Nome<input name="name" id="newSprintName" placeholder="Sprint X" style="width:100%;margin:6px 0" required></label>
      <div class="row" style="gap:8px;margin:6px 0">
        <label class="sr" for="startDate">In√≠cio</label> <input id="startDate" name="start" type="date" required>
        <div id="minicalCreateStart" class="minical" data-for="startDate"></div>
        <label class="sr" for="endDate">Fim</label> <input id="endDate" name="end" type="date" required>
        <div id="minicalCreateEnd" class="minical" data-for="endDate"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" type="button" value="cancel" onclick="document.getElementById('sprintModal').close()">Cancelar</button>
        <button class="btn primary" value="create">Criar</button>
      </div>
    </form>
  </dialog>

  <dialog id="editSprintModal">
    <form method="dialog" id="editSprintForm" style="min-width:320px;max-width:520px;padding:12px">
      <h3>Editar Sprint</h3>
      <label>Nome<input name="name" id="editSprintName" placeholder="Sprint X" style="width:100%;margin:6px 0" required></label>
      <div class="row" style="gap:8px;margin:6px 0">
        <label class="sr" for="editStartDate">In√≠cio</label> <input id="editStartDate" name="start" type="date" required>
        <div id="minicalEditStart" class="minical" data-for="editStartDate"></div>
        <label class="sr" for="editEndDate">Fim</label> <input id="editEndDate" name="end" type="date" required>
        <div id="minicalEditEnd" class="minical" data-for="editEndDate"></div>
      </div>
      <div class="modal-actions">
        <button class="btn" type="button" value="cancel" onclick="document.getElementById('editSprintModal').close()">Cancelar</button>
        <button class="btn primary" value="save">Salvar</button>
      </div>
    </form>
  </dialog>

  <dialog id="editTaskModal">
    <form method="dialog" id="editTaskForm" style="min-width:360px;max-width:640px;padding:16px">
      <h3>Editar tarefa</h3>
      <input name="title" id="et_title" placeholder="T√≠tulo" style="width:100%;margin:6px 0" required>
      <div class="row" style="gap:8px;flex-wrap:wrap">
        <select name="assignee" id="et_assignee"><option>Aline</option><option>Caio</option></select>
        <select name="points" id="et_points"><option>1</option><option>2</option><option>3</option><option>5</option><option>8</option><option>13</option></select>
        <select name="status" id="et_status">
          <option value="todo">A fazer</option><option value="doing">Em andamento</option><option value="done">Conclu√≠da</option><option value="notdone">N√£o conclu√≠da</option>
        </select>
        <select name="epicId" id="et_epic"><option value="">√âpico‚Ä¶</option></select>
        <input name="tags" id="et_tags" placeholder="tags (v√≠rgulas)" style="flex:1" />
      </div>
      <textarea id="et_notes" placeholder="Notas / descri√ß√£o" style="width:100%;margin-top:8px;min-height:120px"></textarea>
      <div id="et_checkMeta" class="miniLabel" style="font-weight:600;margin-top:10px">Checklist</div>
      <div id="et_checklist" style="display:flex;flex-direction:column;gap:8px;margin-top:8px"></div>
      <div class="row" style="gap:8px;margin-top:10px">
        <input id="et_newItem" placeholder="Novo item do checklist..." style="flex:1">
        <button class="btn" id="et_addItem" type="button">Adicionar item</button>
      </div>
      <div class="modal-actions">
        <button class="btn warn" id="et_delete" type="button">Excluir</button>
        <button class="btn" type="button" onclick="document.getElementById('editTaskModal').close()">Cancelar</button>
        <button class="btn primary" id="et_save">Salvar</button>
      </div>
    </form>
  </dialog>

<script>
// ================== Helpers ==================
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtDate = iso => new Date(`${iso}T00:00:00`).toLocaleDateString('pt-BR');
const addDays = (iso, n) => { const d = new Date(`${iso}T00:00:00`); d.setDate(d.getDate()+n); return d.toISOString().slice(0,10); };

function flashSaved(msg){
  const el = document.getElementById('saveToast');
  if(!el) return;
  el.textContent = msg || 'Salvo!';
  el.style.display = 'inline-flex';
  setTimeout(()=>{ el.style.display='none'; }, 1400);
}

function escapeHtml(s){return String(s??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}

// ================== Estado (LocalStorage) ==================
const LS_KEY = 'sprint-tracker-v2-offline';
const LS_BACKUP_KEY = 'sprint-tracker-backup';
let state = { sprints: [], selected: 0 };

// CORRIGIDO: Fun√ß√£o save com backup autom√°tico
function saveLocal(){ 
  try {
    // Fazer backup antes de salvar
    const currentData = localStorage.getItem(LS_KEY);
    if (currentData) {
      localStorage.setItem(LS_BACKUP_KEY, currentData);
    }
    
    // Salvar novo estado
    localStorage.setItem(LS_KEY, JSON.stringify(state)); 
    console.log('üíæ Salvo no localStorage:', state.sprints.length, 'sprints');
  } catch(e) {
    console.error('Erro ao salvar:', e);
    alert('‚ö†Ô∏è Erro ao salvar dados localmente! Veja o console.');
  }
}

// CORRIGIDO: Validar estado ap√≥s carregar
function validateState() {
  if (!state || typeof state !== 'object') {
    console.warn('Estado inv√°lido, criando novo');
    state = { sprints: [], selected: 0 };
    return false;
  }
  if (!Array.isArray(state.sprints)) {
    console.warn('sprints n√£o √© array, corrigindo');
    state.sprints = [];
  }
  if (typeof state.selected !== 'number' || state.selected < 0) {
    state.selected = 0;
  }
  // Garantir que selected est√° dentro dos limites
  if (state.selected >= state.sprints.length) {
    state.selected = Math.max(0, state.sprints.length - 1);
  }
  // Garantir que cada sprint tem estrutura b√°sica
  state.sprints.forEach(s => {
    if (!s.id) s.id = crypto.randomUUID();
    if (!s.name) s.name = 'Sprint';
    if (!Array.isArray(s.tasks)) s.tasks = [];
    if (!Array.isArray(s.epics)) s.epics = [];
  });
  return true;
}

// NOVO: Tentar recuperar de backup
function tryRecoverFromBackup() {
  try {
    const backup = localStorage.getItem(LS_BACKUP_KEY);
    if (backup) {
      console.log('üîÑ Tentando recuperar do backup...');
      const recovered = JSON.parse(backup);
      if (recovered && recovered.sprints && recovered.sprints.length > 0) {
        state = recovered;
        console.log('‚úÖ Recuperado do backup!', state.sprints.length, 'sprints');
        saveLocal();
        return true;
      }
    }
  } catch(e) {
    console.error('Falha ao recuperar backup:', e);
  }
  return false;
}

function load(){
  try{ 
    const raw = localStorage.getItem(LS_KEY); 
    if(raw) {
      state = JSON.parse(raw) || { sprints: [], selected: 0 };
      console.log('üìÇ Carregado do localStorage:', state.sprints.length, 'sprints');
      
      // Se n√£o tem sprints, tentar recuperar do backup
      if (!state.sprints || state.sprints.length === 0) {
        console.warn('‚ö†Ô∏è Nenhuma sprint encontrada! Tentando backup...');
        if (!tryRecoverFromBackup()) {
          console.log('üí° Criando estado inicial...');
          createInitial();
        }
      }
    } else {
      console.log('üì¶ Primeira vez - tentando backup primeiro...');
      if (!tryRecoverFromBackup()) {
        createInitial();
      }
    }
  }catch(e){
    console.error('Erro ao carregar:', e);
    console.log('üîÑ Tentando recuperar do backup...');
    if (!tryRecoverFromBackup()) {
      createInitial();
    }
  }
  
  validateState();
}

load();

// ================== Mini Calend√°rio ==================
function minicalRender(containerId){
  const el = document.getElementById(containerId); if(!el) return;
  const forInput = document.getElementById(el.dataset.for); if(!forInput) return;
  const base = forInput.value ? new Date(forInput.value+'T00:00:00') : new Date();
  const year = base.getFullYear(); const month = base.getMonth();
  const start = new Date(year, month, 1);
  const end = new Date(year, month+1, 0);
  const weeks = ['D','S','T','Q','Q','S','S'];
  let h = '<header><button data-nav="-1" class="btn ghost">‚Äπ</button><span>'+start.toLocaleString('pt-BR',{month:'long',year:'numeric'})+'</span><button data-nav="1" class="btn ghost">‚Ä∫</button></header>';
  h += '<table><thead><tr>'+weeks.map(w=>'<th class="muted">'+w+'</th>').join('')+'</tr></thead><tbody>';
  const pad = start.getDay();
  let day=1, rows='';
  for(let r=0;r<6;r++){
    let t='<tr>';
    for(let c=0;c<7;c++){
      if (r===0 && c<pad) t+='<td></td>';
      else if (day> end.getDate()) t+='<td></td>';
      else{
        const dstr = new Date(year,month,day).toISOString().slice(0,10);
        const sel = (forInput.value===dstr)?' sel':'';
        t += `<td><button data-day="${dstr}" class="${sel}">${day}</button></td>`;
        day++;
      }
    }
    t+='</tr>'; rows+=t; if(day> end.getDate()) break;
  }
  h += rows + '</tbody></table>';
  el.innerHTML = h;
  el.querySelectorAll('button[data-day]').forEach(b=> b.addEventListener('click',()=>{ forInput.value = b.dataset.day; minicalRender(containerId);}));
  el.querySelectorAll('button[data-nav]').forEach(b=> b.addEventListener('click',()=>{
    const offset = Number(b.dataset.nav);
    const cur = forInput.value ? new Date(forInput.value+'T00:00:00') : new Date();
    cur.setMonth(cur.getMonth()+offset);
    forInput.value = cur.toISOString().slice(0,10);
    minicalRender(containerId);
  }));
}

// ================== Render ==================
function currentSprint(){ 
  if (!state.sprints || state.sprints.length === 0) return null;
  if (state.selected < 0 || state.selected >= state.sprints.length) {
    state.selected = 0;
  }
  return state.sprints[state.selected]; 
}

function renderSprintOptions(){
  const sp = currentSprint();
  const html = state.sprints.map((s, idx) => 
    `<option value="${idx}" ${idx===state.selected?'selected':''}>${escapeHtml(s.name || 'Sprint')}</option>`
  ).join('');
  $('#sprintSelect').innerHTML = html;
  console.log('üìã Renderizadas', state.sprints.length, 'sprints, selecionada:', state.selected);
}

function renderHeader(){
  const sp = currentSprint(); 
  if(!sp) {
    $('#sprintTitle').textContent = 'Sprint';
    $('#dateBadge').textContent = '‚Äî';
    return;
  }
  const total = Math.max(1, Math.ceil((new Date(sp.end) - new Date(sp.start)) / 864e5));
  const left = Math.max(0, Math.ceil((new Date(sp.end) - new Date()) / 864e5));
  const ratio = left / total;
  let cls = 'ok'; if (ratio <= 1/3) cls = 'danger'; else if (ratio <= 2/3) cls = 'warn';
  $('#sprintTitle').textContent = sp.name || 'Sprint';
  const badge = $('#dateBadge');
  badge.className = `pill ${cls}`;
  const small = window.innerWidth <= 520;
  if (small){
    const ds = new Date(sp.start).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
    const de = new Date(sp.end).toLocaleDateString('pt-BR', { day:'2-digit', month:'2-digit' });
    badge.textContent = `‚è≥ ${ds} ‚Üí ${de} ‚Ä¢ ${left}/${total}d`;
  } else {
    badge.innerHTML = `‚è≥ ${fmtDate(sp.start)} ‚Üí ${fmtDate(sp.end)} ¬∑ ${left}/${total} dias restantes`;
  }
}

function calcTotals(tasks){
  const fib = n => Number(n)||0;
  const byAssignee = { Aline:{who:'Aline',total:0,done:0,notdone:0}, Caio:{who:'Caio',total:0,done:0,notdone:0} };
  (tasks||[]).forEach(t=>{
    const a = byAssignee[t.assignee]; const pts = fib(t.points);
    if(a){ a.total+=pts; if(t.status==='done') a.done+=pts; if(t.status==='notdone') a.notdone+=pts; }
  });
  return { total: byAssignee.Aline.total + byAssignee.Caio.total, byAssignee };
}

function renderStats(){
  const sp = currentSprint(); 
  if (!sp) return;
  
  const tasks = sp.tasks||[]; 
  const totals = calcTotals(tasks);
  const {Aline, Caio} = totals.byAssignee;
  
  const alinePct = Aline.total? Math.round((Aline.done/Aline.total)*100):0;
  const caioPct  = Caio.total? Math.round((Caio.done/Caio.total)*100):0;
  $('#progressAlineBar').style.width = `${alinePct}%`; $('#progressAlinePct').textContent = `${alinePct}%`;
  $('#progressCaioBar').style.width = `${caioPct}%`; $('#progressCaioPct').textContent = `${caioPct}%`;
  $('#concluidoAline').textContent = `Conclu√≠do Aline: ${Aline.done} pts`;
  $('#concluidoCaio').textContent = `Conclu√≠do Caio: ${Caio.done} pts`;
  
  $('#todoCount').textContent  = tasks.filter(t=>t.status==='todo').length;
  $('#doingCount').textContent = tasks.filter(t=>t.status==='doing').length;
  $('#doneCount').textContent  = tasks.filter(t=>t.status==='done').length;
  $('#notDoneCount').textContent = tasks.filter(t=>t.status==='notdone').length;
  
  const makeCard = (b) => {
    const pctDone = b.total? Math.round((b.done/b.total)*100):0;
    const pctNot  = b.total? Math.round((b.notdone/b.total)*100):0;
    const share   = totals.total? Math.round((b.total/totals.total)*100):0;
    return `<div class="statCard">
      <div class="muted">${b.who}</div>
      <h4 class="n">Planejados: ${b.total} pts</h4>
      <div class="muted">Entregues: ${b.done} pts ¬∑ N√£o concl.: ${b.notdone} pts</div>
      <div class="miniLabel">Progresso</div>
      <div class="progress"><div class="bar" style="width:${pctDone}%"></div></div>
      <div class="muted">Conclus√£o: ${pctDone}%</div>
      <div class="miniLabel">N√£o conclu√≠das</div>
      <div class="progress"><div class="bar" style="width:${pctNot}%"></div></div>
      <div class="muted">${pctNot}% dos pontos</div>
      <div class="miniLabel">Participa√ß√£o</div>
      <div class="progress"><div class="bar" style="width:${share}%"></div></div>
      <div class="muted">${share}% dos pontos</div>
    </div>`;
  };
  $('#statsCards').innerHTML = [makeCard(Aline), makeCard(Caio)].join('');
}

function makeDraggable(card){
  card.addEventListener('dragstart',()=>card.classList.add('dragging'));
  card.addEventListener('dragend',()=>card.classList.remove('dragging'));
}
function getDragAfterElement(container, y){
  const draggables = [...container.querySelectorAll('.task:not(.dragging)')];
  return draggables.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
  }, { offset: Number.NEGATIVE_INFINITY }).element;
}
function persistOrder(status){
  const sp = currentSprint(); if (!sp) return;
  const ids = $$(`#${status} .task`).map(el=>el.dataset.id);
  sp.tasks.forEach(t=>{ if(t.status===status) t._order = ids.indexOf(t.id); });
  saveLocal();
}
function moveTask(id,newStatus){
  const sp = currentSprint(); 
  if (!sp) return;
  const t = sp.tasks.find(x=>x.id===id); 
  if(!t) return;
  t.status = newStatus;
  if(newStatus==='doing' && !t.startedAt) t.startedAt = new Date().toISOString().slice(0,10);
  if(newStatus!=='doing') delete t.startedAt;
  if(newStatus==='done' && !t.doneAt) t.doneAt = new Date().toISOString().slice(0,10);
  if(newStatus!=='done' && t.doneAt) delete t.doneAt;
  if(newStatus==='notdone' && t.doneAt) delete t.doneAt;
  saveLocal();
  renderStats();
}

function renderBoard(){
  $$('.dropzone').forEach(col=>col.innerHTML='');
  const sp = currentSprint(); 
  if (!sp) return;
  
  const epFilter = $('#epicFilter').value;
  const tasks = (sp.tasks||[]).filter(t => epFilter==='all' || t.epicId===epFilter);
  tasks.sort((a,b)=>(a._order||0)-(b._order||0));
  tasks.forEach(task => {
    const card = document.createElement('article');
    const doneLike = (task.status==='done' || task.status==='notdone');
    card.className = `task${task.status==='done'?' done':''}${doneLike?' done-like':''}`;
    card.draggable = true; card.dataset.id = task.id;
    const epicName = (sp.epics || []).find(e=>e.id===task.epicId)?.name || 'Sem √©pico';
    const tagsHTML = (task.tags||[]).map(tag=>`<span class="badge tag">${escapeHtml(tag)}</span>`).join('');
    let daysHTML=''; if(task.status==='doing' && task.startedAt){
      const diff = Math.ceil(Math.abs(new Date()-new Date(`${task.startedAt}T00:00:00`))/864e5);
      daysHTML = `<span class="badge warn" style="margin-left:auto">H√° ${diff} dia(s)</span>`;
    }
    const total = Array.isArray(task.checklist) ? task.checklist.length : 0;
    const done = total ? task.checklist.filter(i=>i.done).length : 0;
    const pct  = total ? Math.round((done/total)*100) : 0;

    const notesPreview = task.notes ? `<div class="notes">${escapeHtml(task.notes).slice(0,180)}</div>` : '';

    card.innerHTML = `<div class="row-between"><div class="title">${escapeHtml(task.title)}</div>${daysHTML}</div>
      <div class="row" style="gap:6px;margin-top:4px;flex-wrap:wrap">
        <span class="badge epic">${escapeHtml(epicName)}</span>
        <span class="badge points">${escapeHtml(String(task.points))} pts</span>
        <span class="badge">üë§ ${escapeHtml(task.assignee)}</span>
        ${tagsHTML}
      </div>
      ${notesPreview}
      <div class="footer">
        <div class="mini">Checklist</div>
        <div class="mini">${done}/${total} (${pct}%)</div>
      </div>
      <div class="progress"><div class="bar" style="width:${pct}%"></div></div>`;
    makeDraggable(card);
    card.addEventListener('dblclick',()=>openEdit(task.id));
    $(`#${task.status}`).appendChild(card);
  });
}

// ======= Edi√ß√£o de tarefa (modal) =======
let et_currentId = null;
function openEdit(id){
  const sp = currentSprint(); 
  if (!sp) return;
  const t = sp.tasks.find(x=>x.id===id); 
  if(!t) return;
  et_currentId = id;
  $('#et_title').value = t.title || '';
  $('#et_assignee').value = t.assignee || 'Aline';
  $('#et_points').value = String(t.points || 0);
  $('#et_status').value = t.status || 'todo';
  const epOpts = (sp.epics||[]).map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join('');
  $('#et_epic').innerHTML = `<option value="">√âpico‚Ä¶</option>${epOpts}`;
  $('#et_epic').value = t.epicId || '';
  $('#et_tags').value = (t.tags||[]).join(', ');
  $('#et_notes').value = t.notes || '';
  if(!Array.isArray(t.checklist)) t.checklist = [];
  renderChecklistModal(t);
  $('#editTaskModal').showModal();
}
function renderChecklistModal(t){
  const host = $('#et_checklist'); host.innerHTML='';
  const total = t.checklist.length || 0;
  const done = t.checklist.filter(i=>i.done).length;
  const pct = total? Math.round((done/total)*100):0;
  $('#et_checkMeta').textContent = `Checklist (${done}/${total} ‚Äî ${pct}%)`;
  t.checklist.forEach((item, idx)=>{
    const row = document.createElement('div');
    row.className = 'row'; row.style.justifyContent='space-between';
    row.innerHTML = `<label class="row" style="gap:8px;align-items:center;flex:1">
        <input type="checkbox" ${item.done?'checked':''} data-idx="${idx}">
        <span class="itemText" style="${item.done?'text-decoration:line-through;opacity:.7':''}">${escapeHtml(item.text||'')}</span>
      </label>
      <button class="btn" data-del="${idx}" type="button">√ó</button>`;
    host.appendChild(row);
  });
  host.querySelectorAll('input[type="checkbox"]').forEach(ch => ch.addEventListener('change', e=>{
    const i = Number(e.target.dataset.idx); t.checklist[i].done = e.target.checked; renderChecklistModal(t);
  }));
  host.querySelectorAll('button[data-del]').forEach(btn => btn.addEventListener('click', ()=>{
    const i = Number(btn.dataset.del); t.checklist.splice(i,1); renderChecklistModal(t);
  }));
}
$('#et_addItem').addEventListener('click', ()=>{
  const sp = currentSprint(); 
  if (!sp) return;
  const t = sp.tasks.find(x=>x.id===et_currentId); 
  if(!t) return;
  const txt = String($('#et_newItem').value||'').trim(); if(!txt) return;
  if(!Array.isArray(t.checklist)) t.checklist = [];
  t.checklist.push({ text: txt, done: false });
  $('#et_newItem').value = '';
  renderChecklistModal(t);
});
$('#et_save').addEventListener('click', (e)=>{
  e.preventDefault();
  const sp = currentSprint(); 
  if (!sp) return;
  const t = sp.tasks.find(x=>x.id===et_currentId); 
  if(!t) return;
  t.title = String($('#et_title').value||'').trim();
  t.assignee = $('#et_assignee').value;
  t.points = Number($('#et_points').value||0);
  const newStatus = $('#et_status').value;
  if(newStatus !== t.status){
    moveTask(t.id, newStatus);
  }
  t.epicId = $('#et_epic').value || '';
  t.tags = String($('#et_tags').value||'').split(',').map(s=>s.trim()).filter(Boolean);
  t.notes = $('#et_notes').value || '';
  $('#editTaskModal').close();
  saveLocal(); 
  renderBoard(); 
  renderStats();
});
$('#et_delete').addEventListener('click', ()=>{
  if(!confirm('Excluir esta tarefa?')) return;
  const sp = currentSprint(); 
  if (!sp) return;
  sp.tasks = (sp.tasks||[]).filter(x=>x.id!==et_currentId);
  $('#editTaskModal').close();
  saveLocal(); 
  renderBoard(); 
  renderStats();
});

// ================== Intera√ß√µes ==================
// CORRIGIDO: Trocar de sprint de forma segura
$('#sprintSelect').addEventListener('change', e=>{
  const idx = Number(e.target.value);
  console.log('üîÑ Trocando para sprint', idx);
  if(idx >= 0 && idx < state.sprints.length){
    state.selected = idx;
    saveLocal();
    renderAll();
    flashSaved('Sprint alterada!');
  }
});

$('#epicFilter').addEventListener('change', ()=>renderBoard());

$('#taskForm').addEventListener('submit', e=>{
  e.preventDefault();
  const fd = new FormData(e.target); 
  const sp = currentSprint();
  if(!sp) return;
  if(!sp.tasks) sp.tasks = [];
  const newTask = {
    id: crypto.randomUUID(),
    title: String(fd.get('title')||'').trim(),
    epicId: String(fd.get('epicId')||''),
    tags: String(fd.get('tags')||'').split(',').map(s=>s.trim()).filter(Boolean),
    assignee: String(fd.get('assignee')||'Aline'),
    points: Number(fd.get('points')||0),
    status: String(fd.get('status')||'todo'),
    notes:'', checklist: []
  };
  if(newTask.status === 'doing') newTask.startedAt = new Date().toISOString().slice(0,10);
  sp.tasks.push(newTask);
  e.target.reset();
  saveLocal(); 
  renderBoard(); 
  renderStats();
  flashSaved('Tarefa adicionada!');
});

$('#addSprintBtn').addEventListener('click', ()=>{
  const last = state.sprints[state.sprints.length-1];
  const todayISO = new Date().toISOString().slice(0,10);
  $('#newSprintName').value = `Sprint ${state.sprints.length+1}`;
  $('#startDate').value = last ? last.end : todayISO;
  $('#endDate').value = last ? addDays(last.end||todayISO, 14) : addDays(todayISO, 14);
  $('#sprintModal').showModal();
  setTimeout(()=>{ minicalRender('minicalCreateStart'); minicalRender('minicalCreateEnd'); },0);
});

$('#sprintForm').addEventListener('submit', e=>{
  e.preventDefault();
  const sd = $('#startDate').value; const ed = $('#endDate').value;
  if (sd && ed && new Date(sd) > new Date(ed)) { alert('A data de FIM n√£o pode ser anterior √† data de IN√çCIO.'); return; }
  const f = new FormData(e.target); 
  const prev = currentSprint();
  const newSprint = {
    id: crypto.randomUUID(), 
    name: String(f.get('name')||'Sprint').trim(),
    start: String(f.get('start')||''), 
    end: String(f.get('end')||''),
    epics: prev?.epics ? JSON.parse(JSON.stringify(prev.epics)) : [],
    tasks: [], 
    createdAt: Date.now()
  };
  state.sprints.push(newSprint); 
  state.selected = state.sprints.length-1;
  $('#sprintModal').close(); 
  saveLocal(); 
  renderAll();
  flashSaved('Sprint criada!');
  console.log('‚ú® Nova sprint criada:', newSprint.name);
});

$('#editSprintBtn').addEventListener('click', ()=>{
  const sp = currentSprint(); if(!sp) return;
  $('#editSprintName').value = sp.name||'';
  $('#editStartDate').value = sp.start||'';
  $('#editEndDate').value = sp.end||'';
  $('#editSprintModal').showModal();
  setTimeout(()=>{ minicalRender('minicalEditStart'); minicalRender('minicalEditEnd'); },0);
});

$('#editSprintForm').addEventListener('submit', e=>{
  e.preventDefault();
  const sd = $('#editStartDate').value; const ed = $('#editEndDate').value;
  if (sd && ed && new Date(sd) > new Date(ed)) { alert('A data de FIM n√£o pode ser anterior √† data de IN√çCIO.'); return; }
  const sp = currentSprint(); 
  if (!sp) return;
  const f = new FormData(e.target);
  sp.name = String(f.get('name')||sp.name).trim();
  sp.start = String(f.get('start')||sp.start);
  sp.end   = String(f.get('end')||sp.end);
  $('#editSprintModal').close(); 
  saveLocal(); 
  renderAll();
  flashSaved('Sprint editada!');
});

$('#addEpicBtn').addEventListener('click', ()=>{
  const input = $('#newEpicName'); 
  const name = String(input.value||'').trim(); 
  if(!name) return;
  const sp = currentSprint(); 
  if(!sp) return;
  if(!sp.epics) sp.epics = [];
  if(sp.epics.some(e=>String(e.name).trim().toLowerCase()===name.toLowerCase())) return alert('J√° existe um √©pico com esse nome.');
  sp.epics.push({id: crypto.randomUUID(), name}); 
  input.value=''; 
  saveLocal(); 
  renderEpicUIs();
  flashSaved('√âpico adicionado!');
});

$('#exportBtn').addEventListener('click', ()=>{
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a'); 
  a.href = URL.createObjectURL(blob); 
  const timestamp = new Date().toISOString().slice(0,16).replace(/:/g,'-');
  a.download = `sprint-backup-${timestamp}.json`; 
  a.click();
  setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
  flashSaved('Backup exportado!');
});

$('#recoverBtn').addEventListener('click', ()=>{
  const options = [];
  
  // Op√ß√£o 1: Backup autom√°tico
  const backup = localStorage.getItem(LS_BACKUP_KEY);
  if (backup) {
    try {
      const data = JSON.parse(backup);
      if (data.sprints && data.sprints.length > 0) {
        options.push({
          name: `Backup Autom√°tico (${data.sprints.length} sprint(s))`,
          data: data
        });
      }
    } catch(e) {}
  }
  
  // Op√ß√£o 2: Buscar outras chaves
  for(let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key !== LS_KEY && key !== LS_BACKUP_KEY && (key.includes('sprint') || key.includes('tracker'))) {
      try {
        const data = JSON.parse(localStorage.getItem(key));
        if (data.sprints && data.sprints.length > 0) {
          options.push({
            name: `${key} (${data.sprints.length} sprint(s))`,
            data: data
          });
        }
      } catch(e) {}
    }
  }
  
  if (options.length === 0) {
    alert('‚ùå Nenhum backup encontrado.\n\n' +
          'Dicas:\n' +
          '1. Se voc√™s usavam Cloud/Firebase, clique em "üåê Cloud" para reconectar\n' +
          '2. Se tem arquivo de backup (.json), use "üìÅ Importar"\n' +
          '3. Verifique no computador da sua namorada se tem os dados');
    return;
  }
  
  const msg = 'üîÑ Backups encontrados:\n\n' + 
              options.map((o, i) => `${i + 1}. ${o.name}`).join('\n') +
              '\n\nDigite o n√∫mero do backup para recuperar (ou 0 para cancelar):';
  
  const choice = prompt(msg);
  const idx = parseInt(choice) - 1;
  
  if (idx >= 0 && idx < options.length) {
    if (confirm(`‚ö†Ô∏è Isso vai substituir os dados atuais.\n\nDeseja continuar?`)) {
      state = options[idx].data;
      validateState();
      saveLocal();
      renderAll();
      alert('‚úÖ Dados recuperados com sucesso!');
      flashSaved('Recuperado!');
    }
  }
});

$('#diagBtn').addEventListener('click', ()=>{
  const cfg = localStorage.getItem('fb_cfg');
  const board = localStorage.getItem('fb_board');
  
  let msg = 'üîç DIAGN√ìSTICO DE CONEX√ÉO\n\n';
  msg += 'üìä Estado Local:\n';
  msg += `  - Sprints: ${state.sprints.length}\n`;
  msg += `  - Tarefas total: ${state.sprints.reduce((sum, s) => sum + (s.tasks?.length || 0), 0)}\n\n`;
  
  msg += 'üíæ Storage:\n';
  msg += `  - Dados principais: ${localStorage.getItem(LS_KEY) ? '‚úÖ OK' : '‚ùå Vazio'}\n`;
  msg += `  - Backup autom√°tico: ${localStorage.getItem(LS_BACKUP_KEY) ? '‚úÖ OK' : '‚ùå Vazio'}\n\n`;
  
  msg += 'üåê Firebase:\n';
  msg += `  - Credenciais salvas: ${cfg ? '‚úÖ Sim' : '‚ùå N√£o'}\n`;
  msg += `  - Board ID salvo: ${board ? '‚úÖ ' + board : '‚ùå N√£o'}\n`;
  msg += `  - Status conex√£o: ${fb.connected ? '‚úÖ Conectado' : '‚ùå Desconectado'}\n`;
  msg += `  - User ID: ${fb.user ? fb.user.uid.slice(0, 12) + '...' : '‚ùå N√£o autenticado'}\n\n`;
  
  if (!fb.connected && cfg && board) {
    msg += 'üí° SOLU√á√ÉO:\n';
    msg += 'Voc√™ tem credenciais salvas mas n√£o est√° conectado.\n';
    msg += 'Clique em "üåê Cloud" para reconectar!\n\n';
  } else if (!cfg) {
    msg += 'üí° SOLU√á√ÉO:\n';
    msg += '1. Acesse: https://console.firebase.google.com/\n';
    msg += '2. Pegue suas credenciais (firebaseConfig)\n';
    msg += '3. Clique em "üåê Cloud" e cole as credenciais\n\n';
  }
  
  msg += 'üîß Comandos √∫teis no console:\n';
  msg += '  ‚Ä¢ For√ßar conex√£o: autoConnect()\n';
  msg += '  ‚Ä¢ Ver dados: state\n';
  msg += '  ‚Ä¢ Salvar: saveLocal()\n';
  
  alert(msg);
  
  // Tamb√©m mostrar no console
  console.log('='.repeat(50));
  console.log(msg);
  console.log('='.repeat(50));
});

$('#importBtn').addEventListener('click', ()=> $('#importFile').click());

// CORRIGIDO: Importa√ß√£o mais robusta
$('#importFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  try{
    const text = await file.text();
    const data = JSON.parse(text);
    let sprints = [];
    
    // Tentar diferentes formatos
    if (Array.isArray(data)) {
      sprints = data;
    } else if (Array.isArray(data?.sprints)) {
      sprints = data.sprints;
    } else if (Array.isArray(data?.state?.sprints)) {
      sprints = data.state.sprints;
    } else {
      alert('Arquivo n√£o reconhecido. Esperado JSON com "sprints".');
      return;
    }
    
    if (!sprints.length) {
      alert('Nenhuma sprint encontrada no arquivo.');
      return;
    }
    
    console.log('üì• Importando', sprints.length, 'sprints');
    
    // Substituir estado
    state.sprints = sprints;
    state.selected = 0;
    
    // Validar e salvar
    validateState();
    saveLocal();
    
    // Renderizar tudo
    renderAll();
    
    alert(`Importa√ß√£o conclu√≠da! ${sprints.length} sprint(s) importada(s).`);
    flashSaved('Importado com sucesso!');
  }catch(err){ 
    console.error('Erro na importa√ß√£o:', err); 
    alert('Falha ao importar JSON: ' + (err?.message || err)); 
  }
  finally{ 
    e.target.value = ''; 
  }
});

$('#resetBtn').addEventListener('click', ()=>{
  const sp = currentSprint(); if(!sp) return;
  if(state.sprints.length<=1) return alert('N√£o √© poss√≠vel excluir a √∫ltima sprint.');
  if(confirm(`Excluir a sprint "${sp.name}"?`)){
    state.sprints.splice(state.selected,1);
    if(state.selected>=state.sprints.length) state.selected = state.sprints.length-1;
    saveLocal(); 
    renderAll();
    flashSaved('Sprint exclu√≠da!');
  }
});

// Atalhos ‚Üê/‚Üí
window.addEventListener('keydown', (e) => {
  const tag = (document.activeElement?.tagName || '').toLowerCase();
  if (tag === 'input' || tag === 'textarea' || e.altKey || e.ctrlKey || e.metaKey) return;
  if (e.key === 'ArrowLeft') {
    if (state.selected > 0) { 
      state.selected -= 1; 
      saveLocal(); 
      renderAll();
      flashSaved('Sprint anterior');
    }
  } else if (e.key === 'ArrowRight') {
    if (state.selected < state.sprints.length - 1) { 
      state.selected += 1; 
      saveLocal(); 
      renderAll();
      flashSaved('Pr√≥xima sprint');
    }
  }
});

// ================== Render All ==================
function renderEpicUIs(){
  const sp = currentSprint(); 
  if (!sp) return;
  
  const epics = sp.epics||[];
  const epicOptions = epics.map(e=>`<option value="${e.id}">${escapeHtml(e.name)}</option>`).join('');
  $('#epicFilter').innerHTML = `<option value="all">Todos os √©picos</option>${epicOptions}`;
  $('#epicSelect').innerHTML = `<option value="">√âpico‚Ä¶</option>${epicOptions}`;
  $('#epicList').innerHTML = epics.map(e=>`<span class="badge">${escapeHtml(e.name)} <button class="btn ghost" data-action="del-epic" data-id="${e.id}">√ó</button></span>`).join('');
  $('#epicList').querySelectorAll('[data-action="del-epic"]').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const sp = currentSprint(); 
      if (!sp) return;
      sp.epics = (sp.epics||[]).filter(x=>x.id!==btn.dataset.id);
      (sp.tasks||[]).forEach(t=>{ if(t.epicId===btn.dataset.id) t.epicId=''; });
      saveLocal(); 
      renderEpicUIs(); 
      renderBoard();
    });
  });
}

function renderAll(){
  const sp = currentSprint();
  if(!sp) {
    console.warn('‚ö†Ô∏è Nenhuma sprint dispon√≠vel para renderizar');
    if(state.sprints.length > 0) {
      state.selected = 0;
    } else {
      return;
    }
  }
  
  console.log('üé® Renderizando sprint:', sp?.name, '(√≠ndice:', state.selected, ')');
  
  renderSprintOptions();
  renderEpicUIs();
  renderHeader();
  renderBoard();
  renderStats();
  
  // DnD zones
  $$('.dropzone').forEach(zone=>{
    zone.addEventListener('dragover', e=>{
      e.preventDefault();
      const after = getDragAfterElement(zone, e.clientY);
      const dragging = $('.task.dragging');
      if(dragging) zone.insertBefore(dragging, after);
    });
    zone.addEventListener('drop', e=>{
      e.preventDefault();
      const dragging = $('.task.dragging'); if(!dragging) return;
      const newStatus = zone.parentElement.dataset.col;
      moveTask(dragging.dataset.id, newStatus);
      persistOrder(newStatus);
      renderBoard();
    });
  });
}

function createInitial(){
  const todayISO = new Date().toISOString().slice(0,10);
  state.sprints = [{
    id: crypto.randomUUID(),
    name:'Sprint 1',
    start: todayISO,
    end: addDays(todayISO, 14),
    createdAt: Date.now(),
    epics:[
      {id:crypto.randomUUID(),name:'Sa√∫de'},
      {id:crypto.randomUUID(),name:'Casa'},
      {id:crypto.randomUUID(),name:'Trabalho'}
    ],
    tasks: [
      { id:crypto.randomUUID(), title:'Configurar o tracker', epicId:'', tags:['setup'], assignee:'Caio', points:5, status:'todo', notes:'', checklist:[] }
    ]
  }];
  state.selected = 0; 
  saveLocal();
  console.log('üÜï Estado inicial criado');
}

// CORRIGIDO: Inicializa√ß√£o
console.log('üöÄ Iniciando Sprint Tracker...');
console.log('üìä Diagn√≥stico:');
console.log('  - Sprints carregadas:', state.sprints.length);
console.log('  - Sprint selecionada:', state.selected);
if (state.sprints.length > 0) {
  state.sprints.forEach((s, i) => {
    console.log(`  - Sprint ${i}: "${s.name}" (${s.tasks?.length || 0} tarefas)`);
  });
}

// Verificar backups
const backup = localStorage.getItem(LS_BACKUP_KEY);
if (backup) {
  try {
    const data = JSON.parse(backup);
    console.log('üíæ Backup dispon√≠vel:', data.sprints?.length || 0, 'sprint(s)');
  } catch(e) {}
}

// Status Firebase
const cfg = localStorage.getItem('fb_cfg');
const board = localStorage.getItem('fb_board');
console.log('');
console.log('üåê Firebase:');
console.log('  - Credenciais salvas:', cfg ? '‚úÖ' : '‚ùå');
console.log('  - Board ID salvo:', board || '‚ùå');

console.log('');
console.log('üîß Comandos dispon√≠veis no console:');
console.log('  - forceCloudConnect() ‚Üí For√ßar conex√£o ao Firebase');
console.log('  - state ‚Üí Ver dados atuais');
console.log('  - saveLocal() ‚Üí Salvar manualmente');

renderAll();

// Re-render header on resize (debounced)
let __rT; 
window.addEventListener('resize', ()=>{ 
  clearTimeout(__rT); 
  __rT = setTimeout(renderHeader, 120); 
});
</script>

<script type="module">
// ======= Cloud Sync (Firebase Firestore) - MODO ONLINE =======
let fb = { 
  app: null, 
  db: null, 
  auth: null, 
  user: null, 
  boardId: null, 
  connected: false, 
  unsub: null,
  saving: false,
  autoConnected: false
};

// Verifica se j√° tem credenciais salvas e conecta automaticamente
async function autoConnect() {
  const savedCfg = localStorage.getItem('fb_cfg');
  const savedBoard = localStorage.getItem('fb_board');
  
  if (savedCfg && savedBoard && !fb.autoConnected) {
    console.log('üîÑ Tentando conectar automaticamente...');
    fb.autoConnected = true;
    try {
      const cfg = JSON.parse(savedCfg);
      await cloudConnect(cfg, savedBoard, true);
    } catch(e) {
      console.warn('Falha na conex√£o autom√°tica:', e);
      fb.autoConnected = false;
    }
  }
}

async function cloudConnect(config = null, boardId = null, isAuto = false){
  try{
    let cfg = config;
    let board = boardId;
    
    // Se n√£o passou config, perguntar ao usu√°rio
    if (!cfg) {
      const previousCfg = localStorage.getItem('fb_cfg') || '';
      
      const helpText = previousCfg ? 
        'Cole o firebaseConfig do Firebase Console\n(ou deixe em branco para usar o salvo):' :
        'Cole o firebaseConfig do Firebase Console:\n\n' +
        '1. Acesse: https://console.firebase.google.com/\n' +
        '2. Clique em ‚öôÔ∏è ‚Üí "Configura√ß√µes do projeto"\n' +
        '3. Role at√© "Seus apps" ‚Üí Clique em </> (Web)\n' +
        '4. Copie TODO o objeto { apiKey: "...", ... }\n\n' +
        'Cole aqui:';
      
      const cfgRaw = prompt(helpText, previousCfg);
      if(cfgRaw === null) return; // Cancelou
      if(cfgRaw === '' && previousCfg) {
        // Usar o salvo
        try { cfg = JSON.parse(previousCfg); } catch(e) { alert('Config salvo inv√°lido!'); return; }
      } else {
        try{ cfg = JSON.parse(cfgRaw); }catch(e){ alert('‚ùå JSON inv√°lido!\n\nVerifique se copiou corretamente.'); return; }
      }
    }
    
    if (!board) {
      const prevBoard = localStorage.getItem('fb_board') || 'casal-1';
      board = prompt('Informe um Board ID √∫nico para voc√™s dois.\n\n‚ö†Ô∏è IMPORTANTE: Ambos devem usar o MESMO Board ID!\n\nExemplo: casal-aline-caio', prevBoard);
      if(!board) return;
    }

    console.log('üîÑ Conectando ao Firebase...');
    const status = document.getElementById('cloudStatus');
    if(status){ 
      status.textContent = 'üîÑ Conectando...'; 
      status.className = "pill warn"; 
    }

    // Salvar credenciais
    if (!isAuto) {
      localStorage.setItem('fb_cfg', JSON.stringify(cfg));
      localStorage.setItem('fb_board', board);
    }

    const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js');
    const { getFirestore, doc, getDoc, setDoc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');
    const { getAuth, signInAnonymously } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js');

    // Inicializar Firebase (s√≥ uma vez)
    if (!fb.app) { 
      fb.app = initializeApp(cfg); 
      console.log('üî• Firebase inicializado');
    }
    
    fb.db = getFirestore(fb.app);
    fb.auth = getAuth(fb.app);
    
    // Login an√¥nimo
    console.log('üîê Autenticando...');
    await signInAnonymously(fb.auth);
    fb.user = fb.auth.currentUser;
    fb.boardId = board;
    fb.connected = true;

    console.log('‚úÖ Conectado ao Cloud! Board:', fb.boardId, 'User:', fb.user.uid.slice(0,8));

    // Atualizar UI
    if(status){ 
      status.textContent = `üåê ${fb.boardId}`; 
      status.className = "pill ok"; 
      status.style.display = 'inline-flex'; 
    }

    const ref = doc(fb.db, 'boards', fb.boardId);

    // Cancelar listener anterior se existir
    if (fb.unsub) fb.unsub();
    
    console.log('üëÇ Iniciando listener em tempo real...');
    
    // LISTENER EM TEMPO REAL - quando o Firebase detecta mudan√ßa
    fb.unsub = onSnapshot(ref, (snap)=>{
      if (!snap.exists()) {
        console.log('üìÑ Documento n√£o existe ainda, ser√° criado');
        return;
      }
      
      const data = snap.data();
      
      // Ignorar se foi este usu√°rio que salvou (evita loop)
      if (data.__lastWriteBy === fb.user?.uid) {
        console.log('‚è≠Ô∏è Ignorando update pr√≥prio');
        return;
      }
      
      // Aplicar estado remoto
      if (data.state){
        try{
          console.log('üì• Recebendo update remoto de:', data.__lastWriteBy?.slice(0,8));
          state = data.state;
          validateState();
          saveLocal(); // Salvar localmente tamb√©m
          renderAll();
          flashSaved('üì° Atualizado!');
        }catch(err){ 
          console.error('‚ùå Erro ao aplicar estado remoto:', err); 
        }
      }
    }, (error) => {
      console.error('‚ùå Erro no listener:', error);
      fb.connected = false;
      const status = document.getElementById('cloudStatus');
      if(status){ 
        status.textContent = '‚ùå Erro: ' + error.code; 
        status.className = "pill danger"; 
      }
      
      if (error.code === 'permission-denied') {
        alert('‚ùå ERRO: Permiss√£o negada!\n\n' +
              'Solu√ß√£o:\n' +
              '1. Acesse: https://console.firebase.google.com/\n' +
              '2. Firestore Database ‚Üí Regras\n' +
              '3. Cole este c√≥digo:\n\n' +
              'rules_version = \'2\';\n' +
              'service cloud.firestore {\n' +
              '  match /databases/{database}/documents {\n' +
              '    match /boards/{boardId} {\n' +
              '      allow read, write: if request.auth != null;\n' +
              '    }\n' +
              '  }\n' +
              '}\n\n' +
              '4. Clique em "Publicar"');
      }
    });

    // Carregar estado inicial do Firebase
    console.log('üì¶ Carregando estado do Cloud...');
    const cur = await getDoc(ref);
    if (cur.exists()){
      const data = cur.data();
      if (data.state){
        console.log('üì• Estado encontrado no Cloud!');
        state = data.state;
        validateState();
        saveLocal();
        renderAll();
        if (!isAuto) flashSaved('Carregado do Cloud!');
      }
    } else {
      // Documento n√£o existe, criar com estado atual
      console.log('üíæ Criando documento inicial no Cloud...');
      await cloudSave();
    }
    
    if (!isAuto) {
      alert('‚úÖ Conectado ao Cloud com sucesso!\n\n' +
            'üåê Board ID: ' + fb.boardId + '\n\n' +
            'Agora voc√™s dois ver√£o as mudan√ßas em TEMPO REAL!\n\n' +
            'üí° Certifique-se de que sua namorada use o MESMO Board ID.');
    } else {
      console.log('‚úÖ Reconectado automaticamente');
      flashSaved('Conectado ao Cloud!');
    }
    
  }catch(err){
    console.error('‚ùå Erro ao conectar:', err);
    fb.connected = false;
    const status = document.getElementById('cloudStatus');
    if(status){ 
      status.textContent = '‚ùå Offline'; 
      status.className = "pill danger"; 
    }
    if (!isAuto) {
      alert('‚ùå Erro ao conectar ao Cloud:\n\n' + 
            err.message + '\n\n' +
            'Verifique:\n' +
            '1. firebaseConfig est√° correto\n' +
            '2. Firestore est√° habilitado no projeto\n' +
            '3. Regras de seguran√ßa est√£o configuradas\n\n' +
            'Detalhes no console (F12)');
    }
  }
}

// Salvar no Cloud
async function cloudSave(){
  if (!fb.connected || !fb.db || !fb.user || fb.saving) {
    console.log('‚è∏Ô∏è Cloud save ignorado (n√£o conectado ou j√° salvando)');
    return;
  }
  
  fb.saving = true;
  
  try{
    const { doc, setDoc } = await import('https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js');
    const ref = doc(fb.db, 'boards', fb.boardId);
    
    // Limpar undefined values (Firestore n√£o aceita)
    const cleanState = JSON.parse(JSON.stringify(state));
    
    await setDoc(ref, { 
      state: cleanState, 
      __lastWriteAt: Date.now(), 
      __lastWriteBy: fb.user.uid 
    });
    
    console.log('‚òÅÔ∏è Salvo no Cloud √†s', new Date().toLocaleTimeString());
    
    // Feedback visual
    const status = document.getElementById('cloudStatus');
    if(status){ 
      const originalText = status.textContent;
      status.textContent = 'üíæ Salvando...'; 
      setTimeout(() => {
        status.textContent = originalText;
      }, 800);
    }
    
  }catch(err){
    console.error('‚ùå cloudSave falhou:', err);
    fb.connected = false;
    const status = document.getElementById('cloudStatus');
    if(status){ 
      status.textContent = '‚ùå Erro ao salvar'; 
      status.className = "pill danger"; 
    }
  } finally {
    fb.saving = false;
  }
}

// INTERCEPTAR saveLocal para tamb√©m salvar no cloud
let cloudSaveTimeout;
const originalSaveLocal = window.saveLocal;
window.saveLocal = function() {
  // Salvar localmente primeiro (r√°pido)
  originalSaveLocal.apply(this, arguments);
  
  // Salvar no cloud com debounce (evitar excesso de writes)
  if (fb.connected) {
    clearTimeout(cloudSaveTimeout);
    cloudSaveTimeout = setTimeout(() => {
      cloudSave();
    }, 300); // 300ms de debounce
  }
};

// Bot√µes
document.getElementById('cloudBtn')?.addEventListener('click', () => cloudConnect());

// Tentar conectar automaticamente ao carregar
setTimeout(() => {
  autoConnect();
}, 1000);

// Fun√ß√£o global para for√ßar conex√£o (pode ser usada no console)
window.forceCloudConnect = function() {
  const cfg = localStorage.getItem('fb_cfg');
  const board = localStorage.getItem('fb_board');
  
  if (!cfg || !board) {
    alert('‚ùå N√£o h√° credenciais salvas.\n\nClique em "üåê Cloud" para configurar.');
    return;
  }
  
  try {
    cloudConnect(JSON.parse(cfg), board, false);
  } catch(e) {
    alert('‚ùå Erro ao conectar: ' + e.message);
  }
};

// Monitorar conex√£o
window.addEventListener('online', () => {
  console.log('üåê Internet restaurada');
  if (!fb.connected) {
    autoConnect();
  }
});

window.addEventListener('offline', () => {
  console.warn('üì° Sem internet - modo offline');
  const status = document.getElementById('cloudStatus');
  if(status){ 
    status.textContent = 'üì° Offline'; 
    status.className = "pill warn"; 
  }
});

// ======= /Cloud Sync =======
</script>
</body>
</html>
